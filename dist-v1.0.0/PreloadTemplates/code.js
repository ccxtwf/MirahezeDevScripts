(function(){"use strict";var o={primary:"MediaWiki:PreloadTemplates/primary",placeholderPrimary:"(insert boilerplate)",secondary:"MediaWiki:PreloadTemplates/secondary",placeholderSecondary:"(insert template)",subpage:"preload",storageCacheAge:9e5,serverCacheAge:900},u={primary:(window.PreloadTemplates||{}).primary,placeholderPrimary:(window.PreloadTemplates||{}).placeholderPrimary,secondary:(window.PreloadTemplates||{}).secondary,placeholderSecondary:(window.PreloadTemplates||{}).placeholderSecondary,subpage:(window.PreloadTemplates||{}).subpage,storageCacheAge:(window.PreloadTemplates||{}).storageCacheAge,serverCacheAge:(window.PreloadTemplates||{}).serverCacheAge},m,c,f,i=mw.config.get(["wgAction","wgFormattedNamespaces"]),S=$("div#wpSummaryLabel"),T=$("div.module_content:first"),j="div.ve-ui-toolbar.ve-ui-positionedTargetToolbar",w="wiki_preload_templates_data_primary",v="wiki_preload_templates_data_secondary",h="wiki_preload_templates_list-pagename_primary",P="wiki_preload_templates_list-pagename_secondary",C="wiki_preload_templates_expiration";if(i.wgAction!=="edit")return;function p(e){return m.msg(e).plain()}function L(e){return e.replace(/<includeonly>(\n)?|(\n)?<\/includeonly>|\s*<noinclude>[^]*?<\/noinclude>/g,"")}function I(e){alert(m.msg("error",'"'+e+'"').plain())}function R(e){localStorage.setItem(w,e.list),localStorage.setItem(v,e.listSecondary),localStorage.setItem(h,e.pagename),localStorage.setItem(P,e.pagenameSecondary),o.storageCacheAge>0&&localStorage.setItem(C,new Date(Date.now()+o.storageCacheAge).getTime())}function D(){localStorage.removeItem(w),localStorage.removeItem(v),localStorage.removeItem(h),localStorage.removeItem(P)}function O(e,r){var a=localStorage.getItem(C),t=localStorage.getItem(h),n=localStorage.getItem(P);return a===null||isNaN(+a)||Date.now()>+a||t!==e||n!==r?(D(),null):[localStorage.getItem(w),localStorage.getItem(v)]}function A(e,r){if(document.selection)e.focus(),window.sel=document.selection.createRange(),window.sel.text=r;else if(e.selectionStart||e.selectionStart===0){var a=e.selectionStart,t=e.selectionEnd;e.value=e.value.substring(0,a)+r+e.value.substring(t,e.value.length)}else e.value+=r}function M(e){var r=(function(){if(typeof window.preloadTemplates_namespace>"u")return i.wgFormattedNamespaces[10];if(typeof i.wgFormattedNamespaces[window.preloadTemplates_namespace]<"u")return i.wgFormattedNamespaces[window.preloadTemplates_namespace];for(var n in i.wgFormattedNamespaces)if(i.wgFormattedNamespaces[n]==window.preloadTemplates_namespace)return i.wgFormattedNamespaces[n];return i.wgFormattedNamespaces[10]})(),a=(function(){return r?r+":":""})(),t=o.subpage==="case-by-case"?a+e:a+e+"/"+o.subpage;$.get(mw.util.wikiScript(),{title:t,action:"raw",ctype:"text/plain"}).done(function(n){var s=L(n);if(s===""){I(t);return}var l=document.getElementsByClassName("cke_source"),d=document.getElementById("wpTextbox1"),b=$(".CodeMirror").get(0),G=$(".cm-editor").get(0);if(window.ve&&ve.init&&ve.init.target&&ve.init.target.active)ve.init.target.getSurface().getModel().getFragment().insertContent(s);else if(l.length)A(l[0],s);else if(b){var V=b.CodeMirror,N=V.getDoc();N.replaceRange(s,N.getCursor())}else if(G){var F=function(z,g){var y=g.view.state&&g.view.state.selection&&g.view.state.selection.ranges&&g.view.state.selection.ranges[0]||{from:0,to:0};g.view.dispatch({changes:{from:y.from,to:y.to,insert:s},selection:{anchor:y.from}}),g.view.focus(),mw.hook("ext.CodeMirror.ready").remove(F)};mw.hook("ext.CodeMirror.ready").add(F)}else d?A(d,s):console.warn("[PreloadTemplates] Could not find textbox to bind to")}).fail(function(){I(t)})}function U(e){e===!0||(S.length?S.after(c):T.length&&T.append(c))}function W(e){m=Y(e),c=$("<div>",{id:"preload-templates"}),c.append($("<span>",{text:p("preload")})),f=$("<div>",{id:"pt-help"}).append($("<a>",{target:"_blank",href:"https://dev.miraheze.org/wiki/PreloadTemplates",title:p("devWiki"),text:"?"})),U()}function x(e,r){return mw.html.element("option",{selected:!0,disabled:!0},r||p("choose"))+e.split(`
`).map(function(a){if(a.trim()==="")return"";if(a.indexOf("*")===0){var t=a.substring(1).trim();if(t.indexOf("|")!==-1){var n=t.split("|");return mw.html.element("option",{value:n[0].trim()},n[1].trim())}else return mw.html.element("option",{value:t},t)}else return mw.html.element("option",{disabled:!0},a.trim(""))}).join()}function k(){var e=u.primary||o.primary;c.append(m.msg("error",mw.html.element("a",{href:mw.util.getUrl(e)},e)).plain(),f)}function X(){if(!(c.find("#pt-list").length>0)){var e=u.primary||o.primary,r=u.secondary||o.secondary,a=O(e,r);if(a!==null){_(a[0],a[1]);return}$.get(mw.util.wikiScript(),{title:e,action:"raw",ctype:"text/plain",maxage:o.serverCacheAge,smaxage:o.serverCacheAge}).done(function(t){r&&$.get(mw.util.wikiScript(),{title:r,action:"raw",ctype:"text/plain",maxage:o.serverCacheAge,smaxage:o.serverCacheAge}).done(function(n){_(t,n),R({list:t,listSecondary:n,pagename:e,pagenameSecondary:r})}).fail(function(){_(t,"")})}).fail(k)}}function _(e,r){var a=L(e),t=L(r);if(a===""){k();return}var n=$("<select>",{id:"pt-list",title:p("help"),html:x(a,o.placeholderPrimary)}).change(function(){var l=$(this),d=l.val();l.find("option:first-child").prop("selected",!0),M(d)}),s=$("<select>",{id:"pt-list-secondary",title:p("help"),html:t===""?void 0:x(t,o.placeholderSecondary),style:t===""?"display:none;":void 0}).change(function(){var l=$(this),d=l.val();l.find("option:first-child").prop("selected",!0),M(d)});c.append(n,s,f)}function Y(e){var r=mw.Message;r.prototype.constructor=mw.Message.prototype.constructor;var a={_i18nLoader:e,msg:function(){var t=Array.prototype.slice.call(arguments);if(t.length!==0){var n=t.shift();return new r(this._i18nLoader.getMessages(),n,t)}}};return["setTempLang","setDefaultLang"].forEach(function(t){a[t]=a._i18nLoader[t].bind(a._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(t){a[t]=a._i18nLoader[t].bind(a)}),a}function B(){var e=new $.Deferred;return mw.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(r){var a=r("ext.gadget.store.FandoomUtilsI18nLoader");a.loadMessages("PreloadTemplates",{}).done(function(t){if(!t){e.resolve(E());return}e.resolve(t)})}).fail(function(r){console.error(r),e.resolve(E())}),e}function E(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new mw.Map;e.set({preload:"Preload template:",choose:"(choose)",help:"Select a template to insert its preloaded syntax at the current position",devWiki:"Check the documentation on Dev Wiki",error:"No valid syntax found at $1 or page is missing."}),mw.Message.prototype.escape===void 0&&(mw.Message.prototype.escape=mw.Message.prototype.escaped);var r={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(a){r[a]=$.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){r[a]=function(){return this}}),r}$.when(B(),mw.loader.using("mediawiki.util")).then(function(e){W(e),i.wgAction==="edit"&&mw.hook("wikipage.content").add(X)})})();
