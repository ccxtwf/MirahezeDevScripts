mw.loader.using(["mediawiki.api","mediawiki.user"],function(){if(!/sysop|bureaucrat|global-admin/.test(mw.config.get("wgUserGroups").join())||window.MassProtectLoaded)return;window.MassProtectLoaded=!0;var m=new mw.Api,t,P=3,r,l=!0,s,i,p,d,f,v,w,y,L;function c(e){return $("<div>",{class:"edit-input-control"}).append($("<div>").text(t.msg(e).plain()),$("<select>",{id:"protect-"+e}).append($("<option>",{value:"",text:t.msg("unset").plain()}),$("<option>",{value:e+"=all",text:t.msg("all").plain()}),$("<option>",{value:e+"=autoconfirmed",text:t.msg("autoconfirmed").plain()}),$("<option>",{value:e+"=sysop",text:t.msg("sysop").plain()})))}function C(){return $("<form>").append($("<fieldset>").append($("<p>",{text:t.msg("protection").plain(),class:"protection-bold"}),c("edit"),c("move"),c("upload"),c("create"),$("<hr/>"),$("<div>",{class:"protection-bold edit-input-control"}).append($("<div>").text(t.msg("expiry").plain()),$("<input>",{type:"text",id:"protect-expiry",placeholder:"indefinite"})),$("<hr/>"),$("<div>",{class:"protection-bold edit-input-control"}).append($("<div>").text(t.msg("reason").plain()),$("<input>",{type:"text",id:"protect-reason"})),$("<hr/>"),$("<p>",{text:t.msg("instructions").plain()}),$("<textarea/>",{id:"text-mass-protect"}),$("<hr/>"),$("<div>",{id:"text-error-output",text:t.msg("error").plain()}).append($("<br/>")))).prop("outerHTML")}function u(){--P===0&&M()}function M(){mw.libs.PowertoolsPlacement.addPortletLink(mw.config.values.skin,{id:"t-mp",href:"#",cssClasses:"custom",label:t.msg("title").plain(),tooltip:"MassProtect",onClick:k})}function k(){if(r){r.show();return}r=new window.dev.modal.Modal({content:C(),id:"form-mass-protect",size:"medium",title:t.msg("title").escape(),buttons:[{id:"mp-start",text:t.msg("initiate").escape(),primary:!0,event:"start"},{id:"mp-pause",text:t.msg("pause").escape(),primary:!0,event:"pause",disabled:!0},{id:"mp-add-pages-in-category",text:t.msg("addCategory").escape(),primary:!0,event:"addCategoryContents"},{text:t.msg("cancel").escape(),event:"close"}],events:{addCategoryContents:A,pause:x,start:U}}),r.create(),s=$("#form-mass-protect"),i=s.find("#text-mass-protect"),p=s.find("#text-error-output"),d=s.find("#protect-expiry"),f=s.find("#protect-create"),v=s.find("#protect-edit"),w=s.find("#protect-move"),y=s.find("#protect-upload"),L=s.find("#protect-reason"),r.show()}function x(){l=!0,r.disableActionButtons("mp-pause"),r.enableActionButtons(["mp-start","mp-add-pages-in-category"])}function U(){l=!1,r.disableActionButtons(["mp-start","mp-add-pages-in-category"]),r.enableActionButtons("mp-pause"),h()}function h(){if(!l){var e=(i.val()||"").split(`
`),n=e[0];n?E(n):(x(),p.append(t.msg("finished").escape()+" "+t.msg("done").escape()+"<br/>")),e=e.slice(1,e.length),i.val(e.join(`
`))}}function A(){var e=prompt(t.msg("categoryPrompt").plain());e&&m.get({action:"query",list:"categorymembers",cmtitle:"Category:"+e,cmlimit:"max"}).done(function(n){var o=n.query;for(var a in o.categorymembers){var g=i.val();i.val(g+o.categorymembers[a].title+`
`)}}).fail(function(n){p.append(t.msg("categoryFail").escape()+e+" : "+n+"<br/>")})}function E(e){m.postWithEditToken({action:"protect",expiry:d.val()||d.attr("placeholder"),protections:f.val()||[v.val(),w.val(),y.val()].filter(Boolean).join("|"),watchlist:"preferences",title:e,reason:L.val()}).done(function(){console.log(t.msg("success",e).plain())}).fail(function(n){console.log(t.msg("fail").escape()+e+": "+n),p.append(t.msg("fail").escape()+e+": "+n+"<br/>")}),setTimeout(h,window.massProtectDelay||1e3)}mw.hook("dev.modal").add(u),mw.hook("dev.powertools.placement").add(u),I().then(function(e){t=F(e),u()});function F(e){var n=mw.Message;n.prototype.constructor=mw.Message.prototype.constructor;var o={_i18nLoader:e,msg:function(){var a=Array.prototype.slice.call(arguments);if(a.length!==0){var g=a.shift();return new n(this._i18nLoader.getMessages(),g,a)}}};return["setTempLang","setDefaultLang"].forEach(function(a){o[a]=o._i18nLoader[a].bind(o._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){o[a]=o._i18nLoader[a].bind(o)}),o}function I(){var e=new $.Deferred;return mw.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(n){var o=n("ext.gadget.store.FandoomUtilsI18nLoader");o.loadMessages("MassProtect",{}).done(function(a){if(!a){e.resolve(b());return}e.resolve(a)})}).fail(function(n){console.error(n),e.resolve(b())}),e}function b(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new mw.Map;e.set({unset:"Unset",all:"Allow all users",autoconfirmed:"Block new users and unregistered users",sysop:"Administrators and Content Moderators only",title:"Mass Protect",edit:"Edit:",move:"Move:",upload:"Upload:",create:"Create:",cancel:"Cancel",addCategory:"Add Category Contents",initiate:"Initiate",finished:"Finished!",done:"Nothing left to do, or next line is blank.",close:"Close",categoryPrompt:"Enter the category name (no category prefix):",categoryFail:"Failed to get contents of ",success:"Protection of $1 successful!",fail:"Failed to protect ",protection:"Protection:",expiry:"Expiry time:",reason:"Reason:",instructions:"Put the name of each page you want to protect on a separate line.",error:"Any errors encountered will appear below",pause:"Pause",comment:"Comment:"}),mw.Message.prototype.escape===void 0&&(mw.Message.prototype.escape=mw.Message.prototype.escaped);var n={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(o){n[o]=$.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(o){n[o]=function(){return this}}),n}});
