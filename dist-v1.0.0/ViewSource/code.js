(function(c,i,o){"use strict";if(c.loadSource)return;var s=i.config.get(["wgAction","wgArticleId","wgArticlePath","wgContentLanguage","wgCurRevisionId","wgFormattedNamespaces","wgNamespaceIds","wgPageContentModel","wgPageName","wgUserLanguage","wgVersion","skin"]),v,d,p,b=3,g,u,l,f,L,m=[];if(s.wgPageContentModel!=="wikitext"||s.wgAction!=="view"||s.wgArticleId===0)return;function w(){--b===0&&C()}function C(){u=o("#mw-content-text"),u.length&&(x(s.skin),i.util.getParamValue("view")==="source"&&c.loadSource())}function x(a){if(!o("#ca-view-source").length){var e=I(a);if(e.length===0){console.error("view-source: skin "+a+" is unsupported");return}i.util.addPortletLink(e.attr("id"),"","View Source","ca-view-source"),f=o("#ca-view-source > a, #ca-view-source > span").first(),f.text(g.msg("viewSource").plain()).attr("href",null).attr("title",g.msg("tooltip").plain()).data("source",!1).on("click",function(r){c[f.data("source")?"hideSource":"loadSource"](),r.preventDefault()})}}function I(a){var e=null;switch(a){case"minerva":e=o("#p-tb");break;case"cosmos":e=o("#cosmos-actionsList-list");break;default:e=o("#p-cactions"),e.length===0&&(e=o("#ca-purge, #ca-watch, #ca-delete, #ca-move").parents(".mw-portlet").last())}return e}function P(a){for(var e=0;e<a.length;e++)a[e]=encodeURIComponent(a[e]);return a.join(":").replace(/ /g,"_")}function h(a){var e,r="";return a.indexOf("#")!==-1&&(e=a.split(/\#/),a=e.shift(),a.length||(a=s.wgPageName),r="#"+e.pop()),a[0]==="/"&&(a=s.wgPageName+a),e=a.split(/\:/),e.length>1&&p[e[0].toLowerCase()]?p[e.shift().toLowerCase()].replace(/\$1/,P(e)+r):s.wgArticlePath.replace("$1",P(e)+r)}function V(a,e,r){return d[r]?e+'<a href="'+i.html.escape(d[r])+'">'+r+"</a>":/\//g.test(a)?"&lt;/"+r:"&lt;"+r}function y(a){return m.push(a),'<a name="h'+(m.length-1)+'"></a>'+a}function U(a,e,r){return r=r||"",'[[<a href="'+i.html.escape(h(e))+'">'+e+"</a>"+r+"]]"}function A(a,e,r){var n,t=r.match(/^(\#?)(\w+)(\:.*)/),S=t&&v[t[1]+t[2]];if(S)return e+t[1]+'<a href="https://www.mediawiki.org/wiki/'+S+'">'+t[2]+"</a>"+t[3];if(r=r.replace(/&lt;\!\-\-[\s\S]*\-\-&gt;/,""),t=r.match(/^(\s*)(.+)(\s*)$/),t===null)return a;if(t[2][0]===":")n=t[2].substring(1);else if(t[2].indexOf("w:")===0)n="w:"+(t[2][2]===":"?t[2].substring(3):"Template:"+t[2].substring(2)),console.log(n);else if(t[2][0]==="/")n=i.config.values.wgPageName+t[2];else{var k=s.wgFormattedNamespaces[10]+":";if(t[2].indexOf(":")!==-1){var j=t[2].split(":")[0];s.wgNamespaceIds[j.toLowerCase()]!==void 0?n=t[2]:n=k+t[2]}else n=k+t[2]}return e+t[1]+'<a href="'+i.html.escape(h(n))+'">'+t[2]+"</a>"+t[3]}function F(a,e,r){return r=r||"",'[<a href="'+i.html.escape(e)+'">'+e+"</a>"+r+"]"}function N(a,e,r,n){var t=s.wgFormattedNamespaces[828]+":"+r.trim();return e+'<a href="'+i.html.escape(h(t))+'">'+r.trim()+"</a>"+n}c.loadSource=function(){f.text(g.msg("viewArticle").plain()).data("source",!0),l?(l.show(),u.hide()):o.get(i.util.getUrl(s.wgPageName,{action:"raw",maxage:"0",smaxage:"0",oldid:i.util.getParamValue("diff")||i.util.getParamValue("oldid")||s.wgCurRevisionId})).done(function(a){l=o('<pre id="source-code">'+a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/({{#invoke:)([\s\S]*?)(\||})/igm,N).replace(/(&lt;\/?)([\w\:\-]+)/g,V).replace(/^((=+)[^\[\]\{\}]+?\2)/gm,y).replace(/\[{2}([^\[\]\{\}\|]+)(\|[^\]]+)?\]{2}/g,U).replace(/\[(https?:\/\/[^ \]]+)([^\]]*)\]/g,F).replace(/((?:^|[^\{])\{\{)([^\{\|\}]+)/g,A).replace(/\r\n|\r|\n/g,"<br />")+"</pre>").insertBefore(u.css("display","none"))})},c.hideSource=function(){l&&(f.text(g.msg("viewSource").plain()).data("source",!1),l.hide(),u.show())};function T(a){var e=i.Message;e.prototype.constructor=i.Message.prototype.constructor;var r={_i18nLoader:a,msg:function(){var n=Array.prototype.slice.call(arguments);if(n.length!==0){var t=n.shift();return new e(this._i18nLoader.getMessages(),t,n)}}};return["setTempLang","setDefaultLang"].forEach(function(n){r[n]=r._i18nLoader[n].bind(r._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(n){r[n]=r._i18nLoader[n].bind(r)}),r}function _(){var a=new o.Deferred;return i.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(e){var r=e("ext.gadget.store.FandoomUtilsI18nLoader");r.loadMessages("ViewSource",{}).done(function(n){if(!n){a.resolve(M());return}a.resolve(n)})}).fail(function(e){console.error(e),a.resolve(M())}),a}function M(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var a=new i.Map;a.set({viewSource:"View source",viewArticle:"View article",tooltip:"Toggle the visibility of the wiki source code of the current page"}),i.Message.prototype.escape===void 0&&(i.Message.prototype.escape=i.Message.prototype.escaped);var e={getMessages:function(){return a}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(r){e[r]=o.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(r){e[r]=function(){return this}}),e}i.hook("userjs.view-source.definitions").add(function(a){v=a.parserFunctions,d=a.parserTags,p=a.interwikiMap,w()}),o.when(_(),i.loader.using("mediawiki.util")).then(function(a){g=T(a),w()}),i.hook("wikipage.content").add(w)})((window.dev=window.dev||{}).viewSource=window.dev.viewSource||{},mediaWiki,jQuery);
