# Mostly written by Claude

name: Build and Deploy to Dist Branch

# Trigger the workflow on push to master branch
on:
  push:
    branches: [ master ]
  # Allow manual triggering from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout master branch
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
    
    - name: Cache Node.js modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-modules-
    
    - name: Install dependencies
      run: npm ci
    
    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Set environment variables
      run: |
        # Bump semver
        LATEST_TAG=$(git describe --abbrev=0 --candidates=1 $(git rev-parse --short origin/dist)) 	# by timestamp
        SEMVER=${LATEST_TAG#v}
        IFS='.' read -r SEMVER_MAJOR SEMVER_MINOR SEMVER_PATCH <<< "$SEMVER"
        SEMVER_PATCH=$((SEMVER_PATCH + 1))
        NEW_TAG="v$SEMVER_MAJOR.$SEMVER_MINOR.$SEMVER_PATCH"
        echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

        # Set CDN entrypoint with version pinning
        echo "CDN_ENTRYPOINT=https://cdn.jsdelivr.net/gh/${{ github.repository }}@$NEW_TAG/dist" >> $GITHUB_ENV

    - name: Publish build result to dist branch
      run: |
        bash ./publish.sh
