mw.loader.using(["mediawiki.api","mediawiki.user"],function(){if(!/sysop|bureaucrat|global-admin/.test(mw.config.get("wgUserGroups").join())||window.MassProtectLoaded)return;window.MassProtectLoaded=!0;var f=new mw.Api,t,M=3,r,u=!0,s,c,d,g,v,w,y,L,h;function l(e){return $("<div>",{class:"edit-input-control"}).append($("<div>").text(t.msg(e).plain()),$("<select>",{id:"protect-"+e}).append($("<option>",{value:"",text:t.msg("unset").plain()}),$("<option>",{value:e+"=all",text:t.msg("all").plain()}),$("<option>",{value:e+"=autoconfirmed",text:t.msg("autoconfirmed").plain()}),$("<option>",{value:e+"=sysop",text:t.msg("sysop").plain()})))}function C(){return $("<form>").append($("<fieldset>").append($("<p>",{text:t.msg("protection").plain(),class:"protection-bold"}),l("edit"),l("move"),l("upload"),l("create"),$("<hr/>"),$("<div>",{class:"protection-bold edit-input-control"}).append($("<div>").text(t.msg("expiry").plain()),$("<input>",{type:"text",id:"protect-expiry",placeholder:"indefinite"})),$("<hr/>"),$("<div>",{class:"protection-bold edit-input-control"}).append($("<div>").text(t.msg("reason").plain()),$("<input>",{type:"text",id:"protect-reason"})),$("<hr/>"),$("<p>",{text:t.msg("instructions").plain()}),$("<textarea/>",{id:"text-mass-protect"}),$("<hr/>"),$("<div>",{id:"text-error-output",text:t.msg("error").plain()}).append($("<br/>")))).prop("outerHTML")}function m(){--M===0&&b()}function b(){mw.libs.PowertoolsPlacement.addPortletLink(mw.config.values.skin,{id:"t-mp",href:"#",cssClasses:"custom",label:t.msg("title").plain(),tooltip:"MassProtect",onClick:E})}function E(){if(r){r.show();return}r=new window.dev.modal.Modal({content:C(),id:"form-mass-protect",size:"medium",title:t.msg("title").escape(),buttons:[{id:"mp-start",text:t.msg("initiate").escape(),primary:!0,event:"start"},{id:"mp-pause",text:t.msg("pause").escape(),primary:!0,event:"pause",disabled:!0},{id:"mp-add-pages-in-category",text:t.msg("addCategory").escape(),primary:!0,event:"addCategoryContents"},{text:t.msg("cancel").escape(),event:"close"}],events:{addCategoryContents:_,pause:P,start:A}}),r.create(),s=$("#form-mass-protect"),c=s.find("#text-mass-protect"),d=s.find("#text-error-output"),g=s.find("#protect-expiry"),v=s.find("#protect-create"),w=s.find("#protect-edit"),y=s.find("#protect-move"),L=s.find("#protect-upload"),h=s.find("#protect-reason"),r.show()}function P(){u=!0,r.disableActionButtons("mp-pause"),r.enableActionButtons(["mp-start","mp-add-pages-in-category"])}function A(){u=!1,r.disableActionButtons(["mp-start","mp-add-pages-in-category"]),r.enableActionButtons("mp-pause"),x()}function x(){if(!u){var e=(c.val()||"").split(`
`),n=e[0];n?T(n):(P(),d.append(t.msg("finished").escape()+" "+t.msg("done").escape()+"<br/>")),e=e.slice(1,e.length),c.val(e.join(`
`))}}function _(){var e=prompt(t.msg("categoryPrompt").plain());e&&f.get({action:"query",list:"categorymembers",cmtitle:"Category:"+e,cmlimit:"max"}).done(function(n){var o=n.query;for(var a in o.categorymembers){var p=c.val();c.val(p+o.categorymembers[a].title+`
`)}}).fail(function(n){d.append(t.msg("categoryFail").escape()+e+" : "+n+"<br/>")})}function T(e){f.postWithEditToken({action:"protect",expiry:g.val()||g.attr("placeholder"),protections:v.val()||[w.val(),y.val(),L.val()].filter(Boolean).join("|"),watchlist:"preferences",title:e,reason:h.val()}).done(function(){console.log(t.msg("success",e).plain())}).fail(function(n){console.log(t.msg("fail").escape()+e+": "+n),d.append(t.msg("fail").escape()+e+": "+n+"<br/>")}),setTimeout(x,window.massProtectDelay||1e3)}mw.hook("dev.modal").add(m),mw.hook("dev.powertools.placement").add(m),D().then(function(e){t=k(e),m()});function k(e){var n=mw.Message;n.prototype.constructor=mw.Message.prototype.constructor;var o={_i18nLoader:e,msg:function(){var a=Array.prototype.slice.call(arguments);if(a.length!==0){var p=a.shift();return new n(this._i18nLoader.getMessages(),p,a)}}};return["setTempLang","setDefaultLang"].forEach(function(a){o[a]=o._i18nLoader[a].bind(o._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){o[a]=o._i18nLoader[a].bind(o)}),o}function D(){var e=new $.Deferred,n=new $.Deferred;function o(){var i=$.Deferred();return mw.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(U){i.resolve(U("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(i.reject),i}function a(i){return i.loadMessages("MassProtect",{})}function p(i){e.resolve(i)}return n.then(o).then(a).then(p).catch(function(i){console.error(i),e.resolve(I())}),mw.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?n.resolve():$.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@dist/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){n.resolve()}).fail(n.reject),e}function I(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new mw.Map;e.set({unset:"Unset",all:"Allow all users",autoconfirmed:"Block new users and unregistered users",sysop:"Administrators and Content Moderators only",title:"Mass Protect",edit:"Edit:",move:"Move:",upload:"Upload:",create:"Create:",cancel:"Cancel",addCategory:"Add Category Contents",initiate:"Initiate",finished:"Finished!",done:"Nothing left to do, or next line is blank.",close:"Close",categoryPrompt:"Enter the category name (no category prefix):",categoryFail:"Failed to get contents of ",success:"Protection of $1 successful!",fail:"Failed to protect ",protection:"Protection:",expiry:"Expiry time:",reason:"Reason:",instructions:"Put the name of each page you want to protect on a separate line.",error:"Any errors encountered will appear below",pause:"Pause",comment:"Comment:"}),mw.Message.prototype.escape===void 0&&(mw.Message.prototype.escape=mw.Message.prototype.escaped);var n={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(o){n[o]=$.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(o){n[o]=function(){return this}}),n}});
