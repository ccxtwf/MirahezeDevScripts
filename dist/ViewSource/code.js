(function(u,n,i){"use strict";if(u.loadSource)return;var s=n.config.get(["wgAction","wgArticleId","wgArticlePath","wgContentLanguage","wgCurRevisionId","wgFormattedNamespaces","wgNamespaceIds","wgPageContentModel","wgPageName","wgUserLanguage","wgVersion","skin"]),m,w,h,C=3,g,l,f,d,P,S=[];if(s.wgPageContentModel!=="wikitext"||s.wgAction!=="view"||s.wgArticleId===0)return;function v(){--C===0&&A()}function A(){l=i("#mw-content-text"),l.length&&(I(s.skin),n.util.getParamValue("view")==="source"&&u.loadSource())}function I(a){if(!i("#ca-view-source").length){var e=T(a);if(e.length===0){console.error("view-source: skin "+a+" is unsupported");return}n.util.addPortletLink(e.attr("id"),"","View Source","ca-view-source"),d=i("#ca-view-source > a, #ca-view-source > span").first(),d.text(g.msg("viewSource").plain()).attr("href",null).attr("title",g.msg("tooltip").plain()).data("source",!1).on("click",function(r){u[d.data("source")?"hideSource":"loadSource"](),r.preventDefault()})}}function T(a){var e=null;switch(a){case"minerva":e=i("#p-tb");break;case"cosmos":e=i("#cosmos-actionsList-list");break;default:e=i("#p-cactions"),e.length===0&&(e=i("#ca-purge, #ca-watch, #ca-delete, #ca-move").parents(".mw-portlet").last())}return e}function M(a){for(var e=0;e<a.length;e++)a[e]=encodeURIComponent(a[e]);return a.join(":").replace(/ /g,"_")}function L(a){var e,r="";return a.indexOf("#")!==-1&&(e=a.split(/\#/),a=e.shift(),a.length||(a=s.wgPageName),r="#"+e.pop()),a[0]==="/"&&(a=s.wgPageName+a),e=a.split(/\:/),e.length>1&&h[e[0].toLowerCase()]?h[e.shift().toLowerCase()].replace(/\$1/,M(e)+r):s.wgArticlePath.replace("$1",M(e)+r)}function _(a,e,r){return w[r]?e+'<a href="'+n.html.escape(w[r])+'">'+r+"</a>":/\//g.test(a)?"&lt;/"+r:"&lt;"+r}function E(a){return S.push(a),'<a name="h'+(S.length-1)+'"></a>'+a}function N(a,e,r){return r=r||"",'[[<a href="'+n.html.escape(L(e))+'">'+e+"</a>"+r+"]]"}function V(a,e,r){var o,t=r.match(/^(\#?)(\w+)(\:.*)/),c=t&&m[t[1]+t[2]];if(c)return e+t[1]+'<a href="https://www.mediawiki.org/wiki/'+c+'">'+t[2]+"</a>"+t[3];if(r=r.replace(/&lt;\!\-\-[\s\S]*\-\-&gt;/,""),t=r.match(/^(\s*)(.+)(\s*)$/),t===null)return a;if(t[2][0]===":")o=t[2].substring(1);else if(t[2].indexOf("w:")===0)o="w:"+(t[2][2]===":"?t[2].substring(3):"Template:"+t[2].substring(2)),console.log(o);else if(t[2][0]==="/")o=n.config.values.wgPageName+t[2];else{var p=s.wgFormattedNamespaces[10]+":";if(t[2].indexOf(":")!==-1){var F=t[2].split(":")[0];s.wgNamespaceIds[F.toLowerCase()]!==void 0?o=t[2]:o=p+t[2]}else o=p+t[2]}return e+t[1]+'<a href="'+n.html.escape(L(o))+'">'+t[2]+"</a>"+t[3]}function k(a,e,r){return r=r||"",'[<a href="'+n.html.escape(e)+'">'+e+"</a>"+r+"]"}function D(a,e,r,o){var t=s.wgFormattedNamespaces[828]+":"+r.trim();return e+'<a href="'+n.html.escape(L(t))+'">'+r.trim()+"</a>"+o}u.loadSource=function(){d.text(g.msg("viewArticle").plain()).data("source",!0),f?(f.show(),l.hide()):i.get(n.util.getUrl(s.wgPageName,{action:"raw",maxage:"0",smaxage:"0",oldid:n.util.getParamValue("diff")||n.util.getParamValue("oldid")||s.wgCurRevisionId})).done(function(a){f=i('<pre id="source-code">'+a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/({{#invoke:)([\s\S]*?)(\||})/igm,D).replace(/(&lt;\/?)([\w\:\-]+)/g,_).replace(/^((=+)[^\[\]\{\}]+?\2)/gm,E).replace(/\[{2}([^\[\]\{\}\|]+)(\|[^\]]+)?\]{2}/g,N).replace(/\[(https?:\/\/[^ \]]+)([^\]]*)\]/g,k).replace(/((?:^|[^\{])\{\{)([^\{\|\}]+)/g,V).replace(/\r\n|\r|\n/g,"<br />")+"</pre>").insertBefore(l.css("display","none"))})},u.hideSource=function(){f&&(d.text(g.msg("viewSource").plain()).data("source",!1),f.hide(),l.show())};function b(a){var e=n.Message;e.prototype.constructor=n.Message.prototype.constructor;var r={_i18nLoader:a,msg:function(){var o=Array.prototype.slice.call(arguments);if(o.length!==0){var t=o.shift();return new e(this._i18nLoader.getMessages(),t,o)}}};return["setTempLang","setDefaultLang"].forEach(function(o){r[o]=r._i18nLoader[o].bind(r._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(o){r[o]=r._i18nLoader[o].bind(r)}),r}function U(){var a=new i.Deferred,e=new i.Deferred;function r(){var c=i.Deferred();return n.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(p){c.resolve(p("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(c.reject),c}function o(c){return c.loadMessages("ViewSource",{})}function t(c){a.resolve(c)}return e.then(r).then(o).then(t).catch(function(c){console.error(c),a.resolve(y())}),n.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?e.resolve():i.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@${NEW_TAG}/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){e.resolve()}).fail(e.reject),a}function y(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var a=new n.Map;a.set({viewSource:"View source",viewArticle:"View article",tooltip:"Toggle the visibility of the wiki source code of the current page"}),n.Message.prototype.escape===void 0&&(n.Message.prototype.escape=n.Message.prototype.escaped);var e={getMessages:function(){return a}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(r){e[r]=i.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(r){e[r]=function(){return this}}),e}n.hook("userjs.view-source.definitions").add(function(a){m=a.parserFunctions,w=a.parserTags,h=a.interwikiMap,v()}),i.when(U(),n.loader.using("mediawiki.util")).then(function(a){g=b(a),v()}),n.hook("wikipage.content").add(v)})((window.dev=window.dev||{}).viewSource=window.dev.viewSource||{},mediaWiki,jQuery);
