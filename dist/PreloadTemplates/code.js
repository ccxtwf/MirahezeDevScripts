(function(){"use strict";var i={primary:"MediaWiki:PreloadTemplates/primary",placeholderPrimary:"(insert boilerplate)",secondary:"MediaWiki:PreloadTemplates/secondary",placeholderSecondary:"(insert template)",subpage:"preload",storageCacheAge:9e5,serverCacheAge:900},u={primary:(window.PreloadTemplates||{}).primary,placeholderPrimary:(window.PreloadTemplates||{}).placeholderPrimary,secondary:(window.PreloadTemplates||{}).secondary,placeholderSecondary:(window.PreloadTemplates||{}).placeholderSecondary,subpage:(window.PreloadTemplates||{}).subpage,storageCacheAge:(window.PreloadTemplates||{}).storageCacheAge,serverCacheAge:(window.PreloadTemplates||{}).serverCacheAge},m,c,f,l=mw.config.get(["wgAction","wgFormattedNamespaces"]),T=$("div#wpSummaryLabel"),y=$("div.module_content:first"),Y="div.ve-ui-toolbar.ve-ui-positionedTargetToolbar",w="wiki_preload_templates_data_primary",v="wiki_preload_templates_data_secondary",h="wiki_preload_templates_list-pagename_primary",P="wiki_preload_templates_list-pagename_secondary",C="wiki_preload_templates_expiration";if(l.wgAction!=="edit")return;function g(e){return m.msg(e).plain()}function _(e){return e.replace(/<includeonly>(\n)?|(\n)?<\/includeonly>|\s*<noinclude>[^]*?<\/noinclude>/g,"")}function A(e){alert(m.msg("error",'"'+e+'"').plain())}function D(e){localStorage.setItem(w,e.list),localStorage.setItem(v,e.listSecondary),localStorage.setItem(h,e.pagename),localStorage.setItem(P,e.pagenameSecondary),i.storageCacheAge>0&&localStorage.setItem(C,new Date(Date.now()+i.storageCacheAge).getTime())}function R(){localStorage.removeItem(w),localStorage.removeItem(v),localStorage.removeItem(h),localStorage.removeItem(P)}function F(e,r){var a=localStorage.getItem(C),t=localStorage.getItem(h),n=localStorage.getItem(P);return a===null||isNaN(+a)||Date.now()>+a||t!==e||n!==r?(R(),null):[localStorage.getItem(w),localStorage.getItem(v)]}function M(e,r){if(document.selection)e.focus(),window.sel=document.selection.createRange(),window.sel.text=r;else if(e.selectionStart||e.selectionStart===0){var a=e.selectionStart,t=e.selectionEnd;e.value=e.value.substring(0,a)+r+e.value.substring(t,e.value.length)}else e.value+=r}function E(e){var r=(function(){if(typeof window.preloadTemplates_namespace>"u")return l.wgFormattedNamespaces[10];if(typeof l.wgFormattedNamespaces[window.preloadTemplates_namespace]<"u")return l.wgFormattedNamespaces[window.preloadTemplates_namespace];for(var n in l.wgFormattedNamespaces)if(l.wgFormattedNamespaces[n]==window.preloadTemplates_namespace)return l.wgFormattedNamespaces[n];return l.wgFormattedNamespaces[10]})(),a=(function(){return r?r+":":""})(),t=i.subpage==="case-by-case"?a+e:a+e+"/"+i.subpage;$.get(mw.util.wikiScript(),{title:t,action:"raw",ctype:"text/plain"}).done(function(n){var o=_(n);if(o===""){A(t);return}var s=document.getElementsByClassName("cke_source"),d=document.getElementById("wpTextbox1"),x=$(".CodeMirror").get(0),j=$(".cm-editor").get(0);if(window.ve&&ve.init&&ve.init.target&&ve.init.target.active)ve.init.target.getSurface().getModel().getFragment().insertContent(o);else if(s.length)M(s[0],o);else if(x){var H=x.CodeMirror,b=H.getDoc();b.replaceRange(o,b.getCursor())}else if(j){var N=function(B,p){var S=p.view.state&&p.view.state.selection&&p.view.state.selection.ranges&&p.view.state.selection.ranges[0]||{from:0,to:0};p.view.dispatch({changes:{from:S.from,to:S.to,insert:o},selection:{anchor:S.from}}),p.view.focus(),mw.hook("ext.CodeMirror.ready").remove(N)};mw.hook("ext.CodeMirror.ready").add(N)}else d?M(d,o):console.warn("[PreloadTemplates] Could not find textbox to bind to")}).fail(function(){A(t)})}function U(e){e===!0||(T.length?T.after(c):y.length&&y.append(c))}function O(e){m=V(e),c=$("<div>",{id:"preload-templates"}),c.append($("<span>",{text:g("preload")})),f=$("<div>",{id:"pt-help"}).append($("<a>",{target:"_blank",href:"https://dev.miraheze.org/wiki/PreloadTemplates",title:g("devWiki"),text:"?"})),U()}function I(e,r){return mw.html.element("option",{selected:!0,disabled:!0},r||g("choose"))+e.split(`
`).map(function(a){if(a.trim()==="")return"";if(a.indexOf("*")===0){var t=a.substring(1).trim();if(t.indexOf("|")!==-1){var n=t.split("|");return mw.html.element("option",{value:n[0].trim()},n[1].trim())}else return mw.html.element("option",{value:t},t)}else return mw.html.element("option",{disabled:!0},a.trim(""))}).join()}function k(){var e=u.primary||i.primary;c.append(m.msg("error",mw.html.element("a",{href:mw.util.getUrl(e)},e)).plain(),f)}function G(){if(!(c.find("#pt-list").length>0)){var e=u.primary||i.primary,r=u.secondary||i.secondary,a=F(e,r);if(a!==null){L(a[0],a[1]);return}$.get(mw.util.wikiScript(),{title:e,action:"raw",ctype:"text/plain",maxage:i.serverCacheAge,smaxage:i.serverCacheAge}).done(function(t){r&&$.get(mw.util.wikiScript(),{title:r,action:"raw",ctype:"text/plain",maxage:i.serverCacheAge,smaxage:i.serverCacheAge}).done(function(n){L(t,n),D({list:t,listSecondary:n,pagename:e,pagenameSecondary:r})}).fail(function(){L(t,"")})}).fail(k)}}function L(e,r){var a=_(e),t=_(r);if(a===""){k();return}var n=$("<select>",{id:"pt-list",title:g("help"),html:I(a,i.placeholderPrimary)}).change(function(){var s=$(this),d=s.val();s.find("option:first-child").prop("selected",!0),E(d)}),o=$("<select>",{id:"pt-list-secondary",title:g("help"),html:t===""?void 0:I(t,i.placeholderSecondary),style:t===""?"display:none;":void 0}).change(function(){var s=$(this),d=s.val();s.find("option:first-child").prop("selected",!0),E(d)});c.append(n,o,f)}function V(e){var r=mw.Message;r.prototype.constructor=mw.Message.prototype.constructor;var a={_i18nLoader:e,msg:function(){var t=Array.prototype.slice.call(arguments);if(t.length!==0){var n=t.shift();return new r(this._i18nLoader.getMessages(),n,t)}}};return["setTempLang","setDefaultLang"].forEach(function(t){a[t]=a._i18nLoader[t].bind(a._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(t){a[t]=a._i18nLoader[t].bind(a)}),a}function W(){var e=new $.Deferred,r=new $.Deferred;function a(){var o=$.Deferred();return mw.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(s){o.resolve(s("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(o.reject),o}function t(o){return o.loadMessages("PreloadTemplates",{})}function n(o){e.resolve(o)}return r.then(a).then(t).then(n).catch(function(o){console.error(o),e.resolve(X())}),mw.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?r.resolve():$.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@5ef63c7fbb0092861de7a34c7d9ed87336f617cf/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){r.resolve()}).fail(r.reject),e}function X(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new mw.Map;e.set({preload:"Preload template:",choose:"(choose)",help:"Select a template to insert its preloaded syntax at the current position",devWiki:"Check the documentation on Dev Wiki",error:"No valid syntax found at $1 or page is missing."}),mw.Message.prototype.escape===void 0&&(mw.Message.prototype.escape=mw.Message.prototype.escaped);var r={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(a){r[a]=$.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){r[a]=function(){return this}}),r}$.when(W(),mw.loader.using("mediawiki.util")).then(function(e){O(e),l.wgAction==="edit"&&mw.hook("wikipage.content").add(G)})})();
