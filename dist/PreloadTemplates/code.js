(function(){"use strict";var m={primary:"MediaWiki:PreloadTemplates/primary",secondary:"MediaWiki:PreloadTemplates/secondary",subpage:"preload",storageCacheAge:9e5,serverCacheAge:900},l=window.PreloadTemplates||{},i={primary:l.primary||m.primary,secondary:l.secondary||m.secondary,subpage:l.subpage||m.subpage,storageCacheAge:typeof l.storageCacheAge=="number"||!isNaN(l.storageCacheAge)?l.storageCacheAge:m.storageCacheAge,serverCacheAge:typeof l.serverCacheAge=="number"||!isNaN(l.storageCacheAge)?l.serverCacheAge:m.serverCacheAge},f,g,v,c=mw.config.get(["wgAction","wgFormattedNamespaces"]),A=$("div#wpSummaryLabel"),T=$("div.module_content:first"),B="div.ve-ui-toolbar.ve-ui-positionedTargetToolbar",w="wiki_preload_templates_data_primary",h="wiki_preload_templates_data_secondary",_="wiki_preload_templates_list-pagename_primary",L="wiki_preload_templates_list-pagename_secondary",y="wiki_preload_templates_expiration";if(c.wgAction!=="edit")return;function u(e){return f.msg(e).plain()}function P(e){return e.replace(/<includeonly>(\n)?|(\n)?<\/includeonly>|\s*<noinclude>[^]*?<\/noinclude>/g,"")}function E(e){alert(f.msg("error",'"'+e+'"').plain())}function R(e){localStorage.setItem(w,e.list),localStorage.setItem(h,e.listSecondary),localStorage.setItem(_,e.pagename),localStorage.setItem(L,e.pagenameSecondary),i.storageCacheAge>0&&localStorage.setItem(y,new Date(Date.now()+i.storageCacheAge).getTime())}function F(){localStorage.removeItem(w),localStorage.removeItem(h),localStorage.removeItem(_),localStorage.removeItem(L)}function U(e,t){var a=localStorage.getItem(y),n=localStorage.getItem(_),o=localStorage.getItem(L);return a===null||isNaN(+a)||Date.now()>+a||n!==e||o!==t?(F(),null):[localStorage.getItem(w),localStorage.getItem(h)]}function M(e,t){if(document.selection)e.focus(),window.sel=document.selection.createRange(),window.sel.text=t;else if(e.selectionStart||e.selectionStart===0){var a=e.selectionStart,n=e.selectionEnd;e.value=e.value.substring(0,a)+t+e.value.substring(n,e.value.length)}else e.value+=t}function I(e){var t=(function(){if(typeof window.preloadTemplates_namespace>"u")return c.wgFormattedNamespaces[10];if(typeof c.wgFormattedNamespaces[window.preloadTemplates_namespace]<"u")return c.wgFormattedNamespaces[window.preloadTemplates_namespace];for(var o in c.wgFormattedNamespaces)if(c.wgFormattedNamespaces[o]==window.preloadTemplates_namespace)return c.wgFormattedNamespaces[o];return c.wgFormattedNamespaces[10]})(),a=(function(){return t?t+":":""})(),n=i.subpage==="case-by-case"?a+e:a+e+"/"+i.subpage;$.get(mw.util.wikiScript(),{title:n,action:"raw",ctype:"text/plain",maxage:0,smaxage:0}).done(function(o){var r=P(o);if(r===""){E(n);return}var s=document.getElementsByClassName("cke_source"),d=document.getElementById("wpTextbox1"),N=$(".CodeMirror").get(0),H=$(".cm-editor").get(0);if(window.ve&&ve.init&&ve.init.target&&ve.init.target.active)ve.init.target.getSurface().getModel().getFragment().insertContent(r);else if(s.length)M(s[0],r);else if(N){var Y=N.CodeMirror,k=Y.getDoc();k.replaceRange(r,k.getCursor())}else if(H){var D=function(z,p){var S=p.view.state&&p.view.state.selection&&p.view.state.selection.ranges&&p.view.state.selection.ranges[0]||{from:0,to:0};p.view.dispatch({changes:{from:S.from,to:S.to,insert:r},selection:{anchor:S.from}}),p.view.focus(),mw.hook("ext.CodeMirror.ready").remove(D)};mw.hook("ext.CodeMirror.ready").add(D)}else d?M(d,r):console.warn("[PreloadTemplates] Could not find textbox to bind to")}).fail(function(){E(n)})}function G(e){e===!0||(A.length?A.after(g):T.length&&T.append(g))}function O(e){f=W(e),g=$("<div>",{id:"preload-templates"}),g.append($("<span>",{text:u("preload")})),v=$("<div>",{id:"pt-help"}).append($("<a>",{target:"_blank",href:"https://dev.miraheze.org/wiki/PreloadTemplates",title:u("devWiki"),text:"?"})),G()}function b(e){return mw.html.element("option",{selected:!0,disabled:!0},u("choose"))+e.split(`
`).map(function(t){if(t.trim()==="")return"";if(t.indexOf("*")===0){var a=t.substring(1).trim();if(a.indexOf("|")!==-1){var n=a.split("|");return mw.html.element("option",{value:n[0].trim()},n[1].trim())}else return mw.html.element("option",{value:a},a)}else return mw.html.element("option",{disabled:!0},t.trim(""))}).join()}function x(){var e=i.primary;g.append(f.msg("error",mw.html.element("a",{href:mw.util.getUrl(e)},e)).plain(),v)}function V(){if(!(g.find("#pt-list").length>0)){var e=i.primary,t=i.secondary,a=U(e,t);if(a!==null){C(a[0],a[1]);return}$.get(mw.util.wikiScript(),{title:e,action:"raw",ctype:"text/plain",maxage:i.serverCacheAge,smaxage:i.serverCacheAge}).done(function(n){t&&$.get(mw.util.wikiScript(),{title:t,action:"raw",ctype:"text/plain",maxage:i.serverCacheAge,smaxage:i.serverCacheAge}).done(function(o){C(n,o),R({list:n,listSecondary:o,pagename:e,pagenameSecondary:t})}).fail(function(){C(n,"")})}).fail(x)}}function C(e,t){var a=P(e),n=P(t);if(a===""){x();return}var o=$("<select>",{id:"pt-list",title:u("help"),html:b(a)}).change(function(){var s=$(this),d=s.val();s.find("option:first-child").prop("selected",!0),I(d)}),r=$("<select>",{id:"pt-list-secondary",title:u("help"),html:n===""?void 0:b(n),style:n===""?"display:none;":void 0}).change(function(){var s=$(this),d=s.val();s.find("option:first-child").prop("selected",!0),I(d)});g.append(o,r,v)}function W(e){var t=mw.Message;t.prototype.constructor=mw.Message.prototype.constructor;var a={_i18nLoader:e,msg:function(){var n=Array.prototype.slice.call(arguments);if(n.length!==0){var o=n.shift();return new t(this._i18nLoader.getMessages(),o,n)}}};return["setTempLang","setDefaultLang"].forEach(function(n){a[n]=a._i18nLoader[n].bind(a._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(n){a[n]=a._i18nLoader[n].bind(a)}),a}function X(){var e=new $.Deferred,t=new $.Deferred;function a(){var r=$.Deferred();return mw.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(s){r.resolve(s("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(r.reject),r}function n(r){return r.loadMessages("PreloadTemplates",{})}function o(r){e.resolve(r)}return t.then(a).then(n).then(o).catch(function(r){console.error(r),e.resolve(j())}),mw.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?t.resolve():$.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@v0.0.3/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){t.resolve()}).fail(t.reject),e}function j(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new mw.Map;e.set({preload:"Preload template:",choose:"(choose)",help:"Select a template to insert its preloaded syntax at the current position",devWiki:"Check the documentation on Dev Wiki",error:"No valid syntax found at $1 or page is missing."}),mw.Message.prototype.escape===void 0&&(mw.Message.prototype.escape=mw.Message.prototype.escaped);var t={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(a){t[a]=$.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){t[a]=function(){return this}}),t}$.when(X(),mw.loader.using("mediawiki.util")).then(function(e){O(e),c.wgAction==="edit"&&mw.hook("wikipage.content").add(V)})})();
