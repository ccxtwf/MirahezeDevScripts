(function(){if(window.MassCategorization&&window.MassCategorization.loaded)return;window.MassCategorization=$.extend({loaded:!0,delay:null,wg:mw.config.get(["wgUserGroups","wgNamespaceIds","wgArticlePath","wgContentLanguage","wgFormattedNamespaces","wgNamespaceNumber"]),modal:null,typemap:{1:"add",2:"remove",3:"replace"},running:!1,refs:{},loading:["api","i18n","modal-js","dorui","placement"],onload:function(e,t){switch(e){case"i18n":var s=x(t);this.i18n=s;break;case"api":this.api=new mw.Api;break;case"dorui":ui=t;break}var i=this.loading.indexOf(e);if(i===-1)throw new Error("Unregistered dependency loaded: "+e);this.loading.splice(i,1),this.loading.length===0&&this.init()},shouldRun:function(){return this.hasRights(["autoconfirmed","bot","sysop","bureaucrat"])},hasRights:function(e){for(var t=e.length;t--;)if(this.wg.wgUserGroups.indexOf(e[t])!==-1)return!0;return!1},getPrefixedModule:function(e){var t=mw.loader.getModuleNames(),s=e+"-",i=s.length,a=t.find(function(r){return r.slice(0,i)===s});return mw.loader.using(a).then(function(r){return r(a)})},preload:function(){L().then(this.onload.bind(this,"i18n")),mw.hook("dev.modal").add(this.onload.bind(this,"modal-js")),mw.hook("dev.doru.ui").add(this.onload.bind(this,"dorui")),mw.hook("dev.powertools.placement").add(this.onload.bind(this,"placement")),mw.loader.using("mediawiki.api").then(this.onload.bind(this,"api"))},buildCategoryUpdate:function(){function e(s){this.onSelectChange(t,s)}var t=ui.div({classes:["MassCat-category-update","MassCat-category-update-add"],children:[ui.div({class:"MassCat-mode-select-wrapper",events:{input:e.bind(this)},children:[this.i18n.msg("mode-dropdown-label").plain()+" ",ui.select({class:"MassCat-mode-select",children:[ui.option({value:1,text:this.i18n.msg("mode-dropdown-add").plain()}),ui.option({value:2,text:this.i18n.msg("mode-dropdown-remove").plain()}),ui.option({value:3,text:this.i18n.msg("mode-dropdown-replace").plain()})]})]}),ui.div({classes:["MassCat-category-inputs"],child:ui.div({class:"MassCat-category-input-wrapper",children:[ui.div({text:this.i18n.msg("category-label").plain()+" "}),ui.input({type:"text",class:"MassCat-category-input",events:{input:(function(){this.running=!1}).bind(this)}})]})})]});return t},onSelectChange:function(e,t){this.running=!1;var s=e.classList.item(1),i=s.replace("MassCat-category-update-",""),a=this.typemap[t.target.value],r=e.querySelector(".MassCat-category-inputs");if(a==="replace"&&i!=="replace")r.appendChild(this.fadeIn(ui.div({classes:["MassCat-category-input-wrapper","MassCat-replacement-category-input-wrapper"],children:[this.i18n.msg("category-replace-label").plain()+" ",ui.input({type:"text",classes:["MassCat-category-input","MassCat-replacement-category-input"],events:{change:(function(){this.running=!1}).bind(this)}})]}),300)),this.reflowModal();else if(a!=="replace"&&i==="replace"){var o=r.querySelector(".MassCat-replacement-category-input-wrapper");console.assert(o===r.lastElementChild),this.fadeOut(o,300,(function(){this.reflowModal()}).bind(this))}e.classList.remove(s),e.classList.add("MassCat-category-update-"+a)},fadeIn:function(e,t){return e.classList.add("MassCat-fading-in"),setTimeout(function(){e.classList.remove("MassCat-fading-in")},t),e},fadeOut:function(e,t,s){e.classList.add("MassCat-fading-out"),setTimeout(function(){e.classList.remove("MassCat-fading-out"),e.parentNode.removeChild(e),s&&s()},t)},buildCategoryAdder:function(){return ui.div({id:"MassCat-category-adder",children:[ui.span({id:"MassCat-add-category",text:"+",events:{click:this.addUpdate.bind(this)}}),ui.br(),this.refs.removeButton=ui.span({id:"MassCat-remove-category",class:["disabled"],text:"-",events:{click:this.removeUpdate.bind(this)}})]})},addUpdate:function(e){e.preventDefault(),this.running=!1,this.refs.updatesList.appendChild(this.fadeIn(this.buildCategoryUpdate(),300)),this.refs.removeButton.classList.remove("disabled"),this.reflowModal()},removeUpdate:function(e){e.preventDefault(),this.running=!1;var t=this.refs.updatesList.querySelectorAll(".MassCat-category-update:not(.MassCat-fading-out)"),s=t[t.length-1];t.length===2&&this.refs.removeButton.classList.add("disabled"),this.fadeOut(s,300,(function(){this.reflowModal()}).bind(this))},buildModalContent:function(){return this.refs.pagesTextarea=ui.textarea({class:"MassCat-pages-textarea",events:{input:(function(){this.running=!1}).bind(this)}}),new MutationObserver(this.reflowModal.bind(this)).observe(this.refs.pagesTextarea,{attributes:!0,attributeFilter:["style"]}),ui.div({id:"MassCat-content-container",children:[ui.div({id:"MassCat-updates-container",children:[this.refs.updatesList=ui.div({id:"MassCat-updates-list",child:this.buildCategoryUpdate()}),this.buildCategoryAdder()]}),ui.div({id:"MassCat-options-container",children:[this.i18n.msg("options-section-label").plain(),ui.label({class:"MassCat-options-label",children:[this.refs.noIncludeCheckbox=ui.input({type:"checkbox",events:{change:(function(){this.running=!1}).bind(this)}}),this.i18n.msg("options-no-include-label").plain()]}),ui.label({class:"MassCat-options-label",children:[this.refs.caseSensitiveCheckbox=ui.input({type:"checkbox",events:{change:(function(){this.running=!1}).bind(this)}}),this.i18n.msg("options-case-sensitive-label").plain()]}),ui.label({class:"MassCat-options-label",children:[this.refs.suppressAutomaticCheckbox=ui.input({type:"checkbox",events:{change:(function(){this.running=!1}).bind(this)}}),this.i18n.msg("options-suppress-automatic-label").plain()]})]}),ui.div({id:"MassCat-pages-container",children:[this.i18n.msg("pages-section-label").plain(),this.refs.pagesTextarea]}),this.refs.statusContainer=ui.div({id:"MassCat-status-container",class:"MassCat-logger MassCat-hidden"}),this.refs.errorsContainer=ui.div({id:"MassCat-errors-container",class:"MassCat-logger MassCat-hidden",child:this.refs.errorsText=ui.div({id:"MassCat-errors-text"})})]})},resetOutput:function(){this.refs.statusContainer.classList.add("MassCat-hidden"),this.refs.errorsContainer.classList.add("MassCat-hidden"),this.refs.statusContainer.innerText="",this.refs.errorsText.innerText=""},showModal:function(){this.modal.show()},escapeRegex:mw.util.escapeRegExp,upcaseFirst:function(e){return e[0].toUpperCase()+e.slice(1)},categorize:function(e,t){var s=this.addStatus(this.i18n.msg("status-fetching",e).plain());this.api.get({action:"query",titles:e,prop:"revisions|categories",rvprop:"content"}).done((function(i){var a=Object.values(i.query.pages)[0];if(a.missing===""){this.logError(this.i18n.msg("error-page-does-not-exist",e).plain());return}var r=a.revisions[0]["*"],o=r,l=a.categories?a.categories.map(function(n){return n.title.slice(n.title.indexOf(":")+1).toLowerCase()}):[],f=[],c={add:[],remove:[],replace:[]};t.forEach(function(n){c[n.mode].push(n)}),c.replace.forEach((function(n){var u=n.category,h=n.replacement,w=this.refs.caseSensitiveCheckbox.checked,m="g"+(w?"":"i"),g=this.escapeRegex(u),v="("+this.categoryAliases.join("|")+")",b="(\\[\\["+v+":\\s*"+g+"\\]\\]|\\[\\["+v+":\\s*"+g+"\\|.*?\\]\\])",p=new RegExp(b,m),k=this.categoryLocal+":"+this.upcaseFirst(h);if(p.test(o)){f.push(this.i18n.msg("change-replaced",u,h).plain()),o=o.replace(p,"[["+k+"]]");var M=l.indexOf(u.toLowerCase());M!==-1&&l.splice(M,1,h.toLowerCase())}}).bind(this)),c.remove.forEach((function(n){var u=n.category,h=this.refs.caseSensitiveCheckbox.checked,w="g"+(h?"":"i"),m=this.escapeRegex(u),g="("+this.categoryAliases.join("|")+")",v="(\\[\\["+g+":\\s*"+m+"\\]\\]|\\[\\["+g+":\\s*"+m+"\\|.*?\\]\\])",b=new RegExp(v,w);if(b.test(o)){f.push(this.i18n.msg("change-removed",u).plain()),o=o.replace(b,"");var p=l.indexOf(u.toLowerCase());p!==-1&&l.splice(p,1)}}).bind(this));var E=c.add.some(function(n){return!l.includes(n.category.toLowerCase())});if(E){var T=c.add.map(function(n){return n.category}),d=`
`;if(T.forEach((function(n){l.includes(n.toLowerCase())||(f.push(this.i18n.msg("change-added",n).plain()),d+="[["+this.categoryLocal+":"+n+`]]
`)}).bind(this)),this.refs.noIncludeCheckbox.checked){var C="</noinclude>";o.slice(-C.length)===C?(o=o.slice(0,-C.length),d=d+"</noinclude>",o.slice(-1)===`
`&&(d=d.trimStart())):d=`
<noinclude>`+d+"</noinclude>"}o+=d}if(r!==o){s=this.replaceStatus(s,this.i18n.msg("status-publishing",e).plain());var y=this.i18n.msg("summary",f.join(", ")).plain();this.refs.suppressAutomaticCheckbox.checked||(y+=" ("+this.i18n.msg("automatic").plain()+")"),this.api.postWithEditToken({action:"edit",watchlist:"nochange",title:e,summary:y,nocreate:"",text:o,bot:!0,minor:!0}).then((function(n){this.removeStatus(s,this.i18n.msg("status-published-waiting",e).plain()),n.error&&n.error.code&&this.logError(this.i18n.msg("error-publishing",e).plain()+": "+n.error.code)}).bind(this)).fail((function(n){this.removeStatus(s,this.i18n.msg("status-failed-publish-waiting",e).plain()),typeof n=="string"?this.logError(this.i18n.msg("error-publishing",e).plain()+": "+n):this.logError(this.i18n.msg("error-publishing",e).plain())}).bind(this))}else this.removeStatus(s,this.i18n.msg("status-no-changes-waiting",e).plain())}).bind(this))},pluckNextLine:function(){var e=this.refs.pagesTextarea.value,t=e.indexOf(`
`);t===-1&&(t=e.length);var s=e.slice(0,t).trim();return this.refs.pagesTextarea.value=e.slice(t+1),s},getUpdates:function(){var e=Array.from(this.refs.updatesList.children);return e.map((function(t){var s=t.querySelector(".MassCat-mode-select"),i=t.querySelectorAll(".MassCat-category-input"),a={mode:this.typemap[s.value],category:i[0].value.trim(),invalid:i[0].value.trim()===""};return a.mode=="replace"&&(a.replacement=i[1].value.trim(),a.invalid=a.invalid||a.replacement.trim()===""),a}).bind(this))},start:function(){if(!this.running){this.resetOutput(),this.reflowModal();for(var e=this.getUpdates(),t=0;t<e.length;t++){var s=e[t];if(s.invalid){if(s.category===""){alert(this.i18n.msg("error-missing-category",t+1).plain());return}else if(s.replacement===""){alert(this.i18n.msg("error-missing-replacement",t+1).plain());return}alert("This code is unreachable. If you can see this, wat");return}}this.running=!0;var i=(function(){if(!this.running){this.logError(this.i18n.msg("interrupted").plain());return}var a=this.pluckNextLine();if(!a){this.running=!1,alert(this.i18n.msg("nothing-left-to-do-prompt").plain()),this.addStatus(this.i18n.msg("status-finished").plain(),!0);return}this.categorize(a,e),setTimeout(i.bind(this),this.delay)}).bind(this);i.call(this)}},addCategoryContents:function(){var e=prompt(this.i18n.msg("add-category-prompt").plain());e===null||e.trim()===""||(this.resetOutput(),this.reflowModal(),this.streamCategoryMembers(e,(function(t){if(t.length===0){this.logError(this.i18n.msg("error-category-does-not-exist",e).plain());return}var s=this.refs.pagesTextarea,i=s.value.length!==0&&s.value.charAt(s.value.length-1)!==`
`,a=i?`
`:"";a+=t.join(`
`),s.value+=a}).bind(this)))},streamCategoryMembers:function(e,t){var s={action:"query",list:"categorymembers",cmtitle:"Category:"+e,cmprop:"title",cmlimit:"max",cachebuster:Date.now()},i=(function(){this.api.get(s).then((function(a){if(a.continue!==void 0&&(Object.assign(s,a.continue),i()),a["query-continue"]!==void 0){var r=[s].concat(Object.values(a["query-continue"]));Object.assign.apply(void 0,r),i()}var o=a.query.categorymembers.map(function(l){return l.title});t(o)}).bind(this)).fail((function(){this.logError(this.i18n.msg("error-failed-to-get-contents",e).plain())}).bind(this))}).bind(this);i()},addStatus:function(e,t){var s=this.buildStatus(e,t),i=this.refs.statusContainer.querySelector(".MassCat-temp");return i!==null?this.refs.statusContainer.replaceChild(s,i):this.refs.statusContainer.appendChild(s),this.refs.statusContainer.classList.remove("MassCat-hidden"),this.reflowModal(),s},removeStatus:function(e,t){this.refs.statusContainer.removeChild(e),t&&this.refs.statusContainer.children.length===0&&this.addStatus(t,!0)},replaceStatus:function(e,t){var s=this.buildStatus(t);return this.refs.statusContainer.replaceChild(s,e),s},buildStatus:function(e,t){return ui.div({classes:{"MassCat-status-message":!0,"MassCat-temp":t},text:e})},logError:function(e){console.error(e),this.refs.errorsContainer.classList.remove("MassCat-hidden"),this.refs.errorsText.appendChild(ui.div({classes:["MassCat-log","MassCat-error"],text:e})),this.reflowModal()},reflowModal:function(){var e=this.modal._modal.$frame,t=this.modal._modal.$body,s=t.prop("scrollTop");if(dev.modal._windowManager.updateWindowSize(this.modal._modal),!e||!t)return console.error("OOUI is dumb");var i=e.get(0),a=t.get(0);a.scrollTop=s,i.addEventListener("transitionend",function(){var r=a.clientHeight,o=a.scrollHeight;o>r?a.classList.add("overflow-allowed"):a.classList.remove("overflow-allowed")},{once:!0})},setDefaultDelay:function(){this.delay||(this.hasRights(["bureaucrat","sysop","bot"])?this.delay=2e3:this.delay=4e3)},createModal:function(){this._loadedModalContent=!1,this.modal=new dev.modal.Modal({id:"MassCatModal",size:"medium",title:this.i18n.msg("modal-title").plain(),content:this.buildModalContent(),closeEscape:!1,events:{addCategoryContents:this.addCategoryContents.bind(this),start:this.start.bind(this)},buttons:[{text:this.i18n.msg("start-button").plain(),event:"start",primary:!0},{text:this.i18n.msg("cancel-button").plain(),event:"close",primary:!1},{text:this.i18n.msg("add-category-contents-button").plain(),event:"addCategoryContents",primary:!1}],close:function(){if(!this.running)return!0;var e=confirm(this.i18n.msg("close-modal-prompt").plain());return e?(this.running=!1,!0):!1}}),this.modal.create()},addToolbarButton:function(){mw.libs.PowertoolsPlacement.addPortletLink(mw.config.values.skin,{id:"MassCat-tools-button",href:"#",cssClasses:"custom",label:this.i18n.msg("my-tools-button").plain(),tooltip:"MassCategorization",onClick:this.showModal.bind(this)})},init:function(){this.categoryLocal=this.wg.wgFormattedNamespaces[14],this.categoryAliases=Object.keys(this.wg.wgNamespaceIds).filter((function(e){return this.wg.wgNamespaceIds[e]===14}).bind(this)).map((function(e){var t=e.replace(/_/g," ");return this.upcaseFirst(t)}).bind(this)),this.setDefaultDelay(),this.createModal(),this.addToolbarButton()}},window.MassCategorization);function x(e){var t=mw.Message;t.prototype.constructor=mw.Message.prototype.constructor;var s={_i18nLoader:e,msg:function(){var i=Array.prototype.slice.call(arguments);if(i.length!==0){var a=i.shift();return new t(this._i18nLoader.getMessages(),a,i)}}};return["setTempLang","setDefaultLang"].forEach(function(i){s[i]=s._i18nLoader[i].bind(s._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(i){s[i]=s._i18nLoader[i].bind(s)}),s}function L(){var e=new $.Deferred,t=new $.Deferred;function s(){var r=$.Deferred();return mw.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(o){r.resolve(o("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(r.reject),r}function i(r){return r.loadMessages("MassCategorization",{})}function a(r){e.resolve(r)}return t.then(s).then(i).then(a).catch(function(r){console.error(r),e.resolve(S())}),mw.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?t.resolve():$.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@dist/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){t.resolve()}).fail(t.reject),e}function S(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new mw.Map;e.set({"modal-title":"MassCategorization","my-tools-button":"MassCategorization","start-button":"Start","pause-button":"Pause","cancel-button":"Cancel","add-category-contents-button":"Add category contents","mode-dropdown-label":"Mode:","mode-dropdown-add":"Add","mode-dropdown-remove":"Remove","mode-dropdown-replace":"Replace","category-label":"Category:","category-replace-label":"Replace with:","options-section-label":"Options:","options-no-include-label":"Do not include in transclusion (for templates)","options-case-sensitive-label":"Case sensitive (remove and replace only)","options-suppress-automatic-label":"Suppress (automatic) from the edit summary","pages-section-label":"Put the name of each page you want to categorize on a separate line","status-description":"Here you will see what the script is doing","status-categorizing":"Categorizing $1...","status-fetching":"Fetching content for $1...","status-publishing":"Publishing $1...","status-published-waiting":"Published $1. Waiting on delay...","status-failed-publish-waiting":"Failed while publishing $1. Waiting on delay...","status-no-changes-waiting":"No changes made. Waiting on delay...","status-finished":"Finished!","status-paused":"Paused","close-modal-prompt":"Are you sure you want to close the modal without finishing?","add-category-prompt":"Please enter the category name (no category prefix):","nothing-left-to-do-prompt":"Nothing left to do, or next line is blank","error-failed-to-get-contents":"Failed to get contents of $1","error-category-does-not-exist":"$1 is empty",interrupted:"Execution was interrupted by a change in the settings","error-page-does-not-exist":"$1 does not exist",automatic:"automatic",summary:"Updating categories: $1","change-added":"added $1","change-removed":"removed $1","change-replaced":"replaced $1 with $2","error-missing-category":"Missing category in update number $1","error-missing-replacement":"Missing replacement category in update number $1","error-publishing":"Could not publish an edit to $1"}),mw.Message.prototype.escape===void 0&&(mw.Message.prototype.escape=mw.Message.prototype.escaped);var t={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(s){t[s]=$.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(s){t[s]=function(){return this}}),t}window.MassCategorization.shouldRun()&&window.MassCategorization.preload()})();
