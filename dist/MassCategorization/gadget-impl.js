(function(n){["autoconfirmed","bot","sysop","bureaucrat"].some(function(d){return(n.config.get("wgUserRights")||[]).indexOf(d)>-1})&&(n.loader.getState("ext.gadget.store.FandoomUiUtilsModal")===null&&n.loader.load("https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@v0.0.2/dist/FandoomUiUtilsModal/gadget-impl.js"),n.loader.getState("ext.gadget.store.FandoomUiUtilsDorui")===null&&n.loader.load("https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@v0.0.2/dist/FandoomUiUtilsDorui/gadget-impl.js"),n.loader.getState("ext.gadget.store.PowertoolsPlacement")===null&&n.loader.load("https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@v0.0.2/dist/PowertoolsPlacement/gadget-impl.js"),n.loader.impl(function(){return["ext.gadget.store.MassCategorization@e8916719",function(d,P,T,O){(function(){if(window.MassCategorization&&window.MassCategorization.loaded)return;window.MassCategorization=d.extend({loaded:!0,delay:null,wg:n.config.get(["wgUserGroups","wgNamespaceIds","wgArticlePath","wgContentLanguage","wgFormattedNamespaces","wgNamespaceNumber"]),modal:null,typemap:{1:"add",2:"remove",3:"replace"},running:!1,refs:{},loading:["api","i18n","modal-js","dorui","placement"],onload:function(t,e){switch(t){case"i18n":var i=k(e);this.i18n=i;break;case"api":this.api=new n.Api;break;case"dorui":ui=e;break}var a=this.loading.indexOf(t);if(a===-1)throw new Error("Unregistered dependency loaded: "+t);this.loading.splice(a,1),this.loading.length===0&&this.init()},shouldRun:function(){return this.hasRights(["autoconfirmed","bot","sysop","bureaucrat"])},hasRights:function(t){for(var e=t.length;e--;)if(this.wg.wgUserGroups.indexOf(t[e])!==-1)return!0;return!1},getPrefixedModule:function(t){var e=n.loader.getModuleNames(),i=t+"-",a=i.length,s=e.find(function(r){return r.slice(0,a)===i});return n.loader.using(s).then(function(r){return r(s)})},preload:function(){S().then(this.onload.bind(this,"i18n")),n.hook("dev.modal").add(this.onload.bind(this,"modal-js")),n.hook("dev.doru.ui").add(this.onload.bind(this,"dorui")),n.hook("dev.powertools.placement").add(this.onload.bind(this,"placement")),n.loader.using("mediawiki.api").then(this.onload.bind(this,"api"))},buildCategoryUpdate:function(){function t(i){this.onSelectChange(e,i)}var e=ui.div({classes:["MassCat-category-update","MassCat-category-update-add"],children:[ui.div({class:"MassCat-mode-select-wrapper",events:{input:t.bind(this)},children:[this.i18n.msg("mode-dropdown-label").plain()+" ",ui.select({class:"MassCat-mode-select",children:[ui.option({value:1,text:this.i18n.msg("mode-dropdown-add").plain()}),ui.option({value:2,text:this.i18n.msg("mode-dropdown-remove").plain()}),ui.option({value:3,text:this.i18n.msg("mode-dropdown-replace").plain()})]})]}),ui.div({classes:["MassCat-category-inputs"],child:ui.div({class:"MassCat-category-input-wrapper",children:[ui.div({text:this.i18n.msg("category-label").plain()+" "}),ui.input({type:"text",class:"MassCat-category-input",events:{input:(function(){this.running=!1}).bind(this)}})]})})]});return e},onSelectChange:function(t,e){this.running=!1;var i=t.classList.item(1),a=i.replace("MassCat-category-update-",""),s=this.typemap[e.target.value],r=t.querySelector(".MassCat-category-inputs");if(s==="replace"&&a!=="replace")r.appendChild(this.fadeIn(ui.div({classes:["MassCat-category-input-wrapper","MassCat-replacement-category-input-wrapper"],children:[this.i18n.msg("category-replace-label").plain()+" ",ui.input({type:"text",classes:["MassCat-category-input","MassCat-replacement-category-input"],events:{change:(function(){this.running=!1}).bind(this)}})]}),300)),this.reflowModal();else if(s!=="replace"&&a==="replace"){var l=r.querySelector(".MassCat-replacement-category-input-wrapper");console.assert(l===r.lastElementChild),this.fadeOut(l,300,(function(){this.reflowModal()}).bind(this))}t.classList.remove(i),t.classList.add("MassCat-category-update-"+s)},fadeIn:function(t,e){return t.classList.add("MassCat-fading-in"),setTimeout(function(){t.classList.remove("MassCat-fading-in")},e),t},fadeOut:function(t,e,i){t.classList.add("MassCat-fading-out"),setTimeout(function(){t.classList.remove("MassCat-fading-out"),t.parentNode.removeChild(t),i&&i()},e)},buildCategoryAdder:function(){return ui.div({id:"MassCat-category-adder",children:[ui.span({id:"MassCat-add-category",text:"+",events:{click:this.addUpdate.bind(this)}}),ui.br(),this.refs.removeButton=ui.span({id:"MassCat-remove-category",class:["disabled"],text:"-",events:{click:this.removeUpdate.bind(this)}})]})},addUpdate:function(t){t.preventDefault(),this.running=!1,this.refs.updatesList.appendChild(this.fadeIn(this.buildCategoryUpdate(),300)),this.refs.removeButton.classList.remove("disabled"),this.reflowModal()},removeUpdate:function(t){t.preventDefault(),this.running=!1;var e=this.refs.updatesList.querySelectorAll(".MassCat-category-update:not(.MassCat-fading-out)"),i=e[e.length-1];e.length===2&&this.refs.removeButton.classList.add("disabled"),this.fadeOut(i,300,(function(){this.reflowModal()}).bind(this))},buildModalContent:function(){return this.refs.pagesTextarea=ui.textarea({class:"MassCat-pages-textarea",events:{input:(function(){this.running=!1}).bind(this)}}),new MutationObserver(this.reflowModal.bind(this)).observe(this.refs.pagesTextarea,{attributes:!0,attributeFilter:["style"]}),ui.div({id:"MassCat-content-container",children:[ui.div({id:"MassCat-updates-container",children:[this.refs.updatesList=ui.div({id:"MassCat-updates-list",child:this.buildCategoryUpdate()}),this.buildCategoryAdder()]}),ui.div({id:"MassCat-options-container",children:[this.i18n.msg("options-section-label").plain(),ui.label({class:"MassCat-options-label",children:[this.refs.noIncludeCheckbox=ui.input({type:"checkbox",events:{change:(function(){this.running=!1}).bind(this)}}),this.i18n.msg("options-no-include-label").plain()]}),ui.label({class:"MassCat-options-label",children:[this.refs.caseSensitiveCheckbox=ui.input({type:"checkbox",events:{change:(function(){this.running=!1}).bind(this)}}),this.i18n.msg("options-case-sensitive-label").plain()]}),ui.label({class:"MassCat-options-label",children:[this.refs.suppressAutomaticCheckbox=ui.input({type:"checkbox",events:{change:(function(){this.running=!1}).bind(this)}}),this.i18n.msg("options-suppress-automatic-label").plain()]})]}),ui.div({id:"MassCat-pages-container",children:[this.i18n.msg("pages-section-label").plain(),this.refs.pagesTextarea]}),this.refs.statusContainer=ui.div({id:"MassCat-status-container",class:"MassCat-logger MassCat-hidden"}),this.refs.errorsContainer=ui.div({id:"MassCat-errors-container",class:"MassCat-logger MassCat-hidden",child:this.refs.errorsText=ui.div({id:"MassCat-errors-text"})})]})},resetOutput:function(){this.refs.statusContainer.classList.add("MassCat-hidden"),this.refs.errorsContainer.classList.add("MassCat-hidden"),this.refs.statusContainer.innerText="",this.refs.errorsText.innerText=""},showModal:function(){this.modal.show()},escapeRegex:n.util.escapeRegExp,upcaseFirst:function(t){return t[0].toUpperCase()+t.slice(1)},categorize:function(t,e){var i=this.addStatus(this.i18n.msg("status-fetching",t).plain());this.api.get({action:"query",titles:t,prop:"revisions|categories",rvprop:"content"}).done((function(a){var s=Object.values(a.query.pages)[0];if(s.missing===""){this.logError(this.i18n.msg("error-page-does-not-exist",t).plain());return}var r=s.revisions[0]["*"],l=r,c=s.categories?s.categories.map(function(o){return o.title.slice(o.title.indexOf(":")+1).toLowerCase()}):[],v=[],h={add:[],remove:[],replace:[]};e.forEach(function(o){h[o.mode].push(o)}),h.replace.forEach((function(o){var g=o.category,p=o.replacement,w=this.refs.caseSensitiveCheckbox.checked,b="g"+(w?"":"i"),f=this.escapeRegex(g),C="("+this.categoryAliases.join("|")+")",y="(\\[\\["+C+":\\s*"+f+"\\]\\]|\\[\\["+C+":\\s*"+f+"\\|.*?\\]\\])",m=new RegExp(y,b),j=this.categoryLocal+":"+this.upcaseFirst(p);if(m.test(l)){v.push(this.i18n.msg("change-replaced",g,p).plain()),l=l.replace(m,"[["+j+"]]");var L=c.indexOf(g.toLowerCase());L!==-1&&c.splice(L,1,p.toLowerCase())}}).bind(this)),h.remove.forEach((function(o){var g=o.category,p=this.refs.caseSensitiveCheckbox.checked,w="g"+(p?"":"i"),b=this.escapeRegex(g),f="("+this.categoryAliases.join("|")+")",C="(\\[\\["+f+":\\s*"+b+"\\]\\]|\\[\\["+f+":\\s*"+b+"\\|.*?\\]\\])",y=new RegExp(C,w);if(y.test(l)){v.push(this.i18n.msg("change-removed",g).plain()),l=l.replace(y,"");var m=c.indexOf(g.toLowerCase());m!==-1&&c.splice(m,1)}}).bind(this));var E=h.add.some(function(o){return!c.includes(o.category.toLowerCase())});if(E){var z=h.add.map(function(o){return o.category}),u=`
`;if(z.forEach((function(o){c.includes(o.toLowerCase())||(v.push(this.i18n.msg("change-added",o).plain()),u+="[["+this.categoryLocal+":"+o+`]]
`)}).bind(this)),this.refs.noIncludeCheckbox.checked){var M="</noinclude>";l.slice(-M.length)===M?(l=l.slice(0,-M.length),u=u+"</noinclude>",l.slice(-1)===`
`&&(u=u.trimStart())):u=`
<noinclude>`+u+"</noinclude>"}l+=u}if(r!==l){i=this.replaceStatus(i,this.i18n.msg("status-publishing",t).plain());var x=this.i18n.msg("summary",v.join(", ")).plain();this.refs.suppressAutomaticCheckbox.checked||(x+=" ("+this.i18n.msg("automatic").plain()+")"),this.api.postWithEditToken({action:"edit",watchlist:"nochange",title:t,summary:x,nocreate:"",text:l,bot:!0,minor:!0}).then((function(o){this.removeStatus(i,this.i18n.msg("status-published-waiting",t).plain()),o.error&&o.error.code&&this.logError(this.i18n.msg("error-publishing",t).plain()+": "+o.error.code)}).bind(this)).fail((function(o){this.removeStatus(i,this.i18n.msg("status-failed-publish-waiting",t).plain()),typeof o=="string"?this.logError(this.i18n.msg("error-publishing",t).plain()+": "+o):this.logError(this.i18n.msg("error-publishing",t).plain())}).bind(this))}else this.removeStatus(i,this.i18n.msg("status-no-changes-waiting",t).plain())}).bind(this))},pluckNextLine:function(){var t=this.refs.pagesTextarea.value,e=t.indexOf(`
`);e===-1&&(e=t.length);var i=t.slice(0,e).trim();return this.refs.pagesTextarea.value=t.slice(e+1),i},getUpdates:function(){var t=Array.from(this.refs.updatesList.children);return t.map((function(e){var i=e.querySelector(".MassCat-mode-select"),a=e.querySelectorAll(".MassCat-category-input"),s={mode:this.typemap[i.value],category:a[0].value.trim(),invalid:a[0].value.trim()===""};return s.mode=="replace"&&(s.replacement=a[1].value.trim(),s.invalid=s.invalid||s.replacement.trim()===""),s}).bind(this))},start:function(){if(!this.running){this.resetOutput(),this.reflowModal();for(var t=this.getUpdates(),e=0;e<t.length;e++){var i=t[e];if(i.invalid){if(i.category===""){alert(this.i18n.msg("error-missing-category",e+1).plain());return}else if(i.replacement===""){alert(this.i18n.msg("error-missing-replacement",e+1).plain());return}alert("This code is unreachable. If you can see this, wat");return}}this.running=!0;var a=(function(){if(!this.running){this.logError(this.i18n.msg("interrupted").plain());return}var s=this.pluckNextLine();if(!s){this.running=!1,alert(this.i18n.msg("nothing-left-to-do-prompt").plain()),this.addStatus(this.i18n.msg("status-finished").plain(),!0);return}this.categorize(s,t),setTimeout(a.bind(this),this.delay)}).bind(this);a.call(this)}},addCategoryContents:function(){var t=prompt(this.i18n.msg("add-category-prompt").plain());t===null||t.trim()===""||(this.resetOutput(),this.reflowModal(),this.streamCategoryMembers(t,(function(e){if(e.length===0){this.logError(this.i18n.msg("error-category-does-not-exist",t).plain());return}var i=this.refs.pagesTextarea,a=i.value.length!==0&&i.value.charAt(i.value.length-1)!==`
`,s=a?`
`:"";s+=e.join(`
`),i.value+=s}).bind(this)))},streamCategoryMembers:function(t,e){var i={action:"query",list:"categorymembers",cmtitle:"Category:"+t,cmprop:"title",cmlimit:"max",cachebuster:Date.now()},a=(function(){this.api.get(i).then((function(s){if(s.continue!==void 0&&(Object.assign(i,s.continue),a()),s["query-continue"]!==void 0){var r=[i].concat(Object.values(s["query-continue"]));Object.assign.apply(void 0,r),a()}var l=s.query.categorymembers.map(function(c){return c.title});e(l)}).bind(this)).fail((function(){this.logError(this.i18n.msg("error-failed-to-get-contents",t).plain())}).bind(this))}).bind(this);a()},addStatus:function(t,e){var i=this.buildStatus(t,e),a=this.refs.statusContainer.querySelector(".MassCat-temp");return a!==null?this.refs.statusContainer.replaceChild(i,a):this.refs.statusContainer.appendChild(i),this.refs.statusContainer.classList.remove("MassCat-hidden"),this.reflowModal(),i},removeStatus:function(t,e){this.refs.statusContainer.removeChild(t),e&&this.refs.statusContainer.children.length===0&&this.addStatus(e,!0)},replaceStatus:function(t,e){var i=this.buildStatus(e);return this.refs.statusContainer.replaceChild(i,t),i},buildStatus:function(t,e){return ui.div({classes:{"MassCat-status-message":!0,"MassCat-temp":e},text:t})},logError:function(t){console.error(t),this.refs.errorsContainer.classList.remove("MassCat-hidden"),this.refs.errorsText.appendChild(ui.div({classes:["MassCat-log","MassCat-error"],text:t})),this.reflowModal()},reflowModal:function(){var t=this.modal._modal.$frame,e=this.modal._modal.$body,i=e.prop("scrollTop");if(dev.modal._windowManager.updateWindowSize(this.modal._modal),!t||!e)return console.error("OOUI is dumb");var a=t.get(0),s=e.get(0);s.scrollTop=i,a.addEventListener("transitionend",function(){var r=s.clientHeight,l=s.scrollHeight;l>r?s.classList.add("overflow-allowed"):s.classList.remove("overflow-allowed")},{once:!0})},setDefaultDelay:function(){this.delay||(this.hasRights(["bureaucrat","sysop","bot"])?this.delay=2e3:this.delay=4e3)},createModal:function(){this._loadedModalContent=!1,this.modal=new dev.modal.Modal({id:"MassCatModal",size:"medium",title:this.i18n.msg("modal-title").plain(),content:this.buildModalContent(),closeEscape:!1,events:{addCategoryContents:this.addCategoryContents.bind(this),start:this.start.bind(this)},buttons:[{text:this.i18n.msg("start-button").plain(),event:"start",primary:!0},{text:this.i18n.msg("cancel-button").plain(),event:"close",primary:!1},{text:this.i18n.msg("add-category-contents-button").plain(),event:"addCategoryContents",primary:!1}],close:function(){if(!this.running)return!0;var t=confirm(this.i18n.msg("close-modal-prompt").plain());return t?(this.running=!1,!0):!1}}),this.modal.create()},addToolbarButton:function(){n.libs.PowertoolsPlacement.addPortletLink(n.config.values.skin,{id:"MassCat-tools-button",href:"#",cssClasses:"custom",label:this.i18n.msg("my-tools-button").plain(),tooltip:"MassCategorization",onClick:this.showModal.bind(this)})},init:function(){this.categoryLocal=this.wg.wgFormattedNamespaces[14],this.categoryAliases=Object.keys(this.wg.wgNamespaceIds).filter((function(t){return this.wg.wgNamespaceIds[t]===14}).bind(this)).map((function(t){var e=t.replace(/_/g," ");return this.upcaseFirst(e)}).bind(this)),this.setDefaultDelay(),this.createModal(),this.addToolbarButton()}},window.MassCategorization);function k(t){var e=n.Message;e.prototype.constructor=n.Message.prototype.constructor;var i={_i18nLoader:t,msg:function(){var a=Array.prototype.slice.call(arguments);if(a.length!==0){var s=a.shift();return new e(this._i18nLoader.getMessages(),s,a)}}};return["setTempLang","setDefaultLang"].forEach(function(a){i[a]=i._i18nLoader[a].bind(i._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){i[a]=i._i18nLoader[a].bind(i)}),i}function S(){var t=new d.Deferred,e=new d.Deferred;function i(){var r=d.Deferred();return n.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(l){r.resolve(l("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(r.reject),r}function a(r){return r.loadMessages("MassCategorization",{})}function s(r){t.resolve(r)}return e.then(i).then(a).then(s).catch(function(r){console.error(r),t.resolve(U())}),n.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?e.resolve():d.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@v0.0.2/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){e.resolve()}).fail(e.reject),t}function U(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var t=new n.Map;t.set({"modal-title":"MassCategorization","my-tools-button":"MassCategorization","start-button":"Start","pause-button":"Pause","cancel-button":"Cancel","add-category-contents-button":"Add category contents","mode-dropdown-label":"Mode:","mode-dropdown-add":"Add","mode-dropdown-remove":"Remove","mode-dropdown-replace":"Replace","category-label":"Category:","category-replace-label":"Replace with:","options-section-label":"Options:","options-no-include-label":"Do not include in transclusion (for templates)","options-case-sensitive-label":"Case sensitive (remove and replace only)","options-suppress-automatic-label":"Suppress (automatic) from the edit summary","pages-section-label":"Put the name of each page you want to categorize on a separate line","status-description":"Here you will see what the script is doing","status-categorizing":"Categorizing $1...","status-fetching":"Fetching content for $1...","status-publishing":"Publishing $1...","status-published-waiting":"Published $1. Waiting on delay...","status-failed-publish-waiting":"Failed while publishing $1. Waiting on delay...","status-no-changes-waiting":"No changes made. Waiting on delay...","status-finished":"Finished!","status-paused":"Paused","close-modal-prompt":"Are you sure you want to close the modal without finishing?","add-category-prompt":"Please enter the category name (no category prefix):","nothing-left-to-do-prompt":"Nothing left to do, or next line is blank","error-failed-to-get-contents":"Failed to get contents of $1","error-category-does-not-exist":"$1 is empty",interrupted:"Execution was interrupted by a change in the settings","error-page-does-not-exist":"$1 does not exist",automatic:"automatic",summary:"Updating categories: $1","change-added":"added $1","change-removed":"removed $1","change-replaced":"replaced $1 with $2","error-missing-category":"Missing category in update number $1","error-missing-replacement":"Missing replacement category in update number $1","error-publishing":"Could not publish an edit to $1"}),n.Message.prototype.escape===void 0&&(n.Message.prototype.escape=n.Message.prototype.escaped);var e={getMessages:function(){return t}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(i){e[i]=d.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(i){e[i]=function(){return this}}),e}window.MassCategorization.shouldRun()&&window.MassCategorization.preload()})()},{css:["#MassCat-content-container{padding:8px;font-size:14px}#MassCatModal .oo-ui-window-body{overflow-y:hidden}#MassCatModal .oo-ui-window-body.overflow-allowed{overflow-y:auto}#MassCatModal .oo-ui-processDialog-actions-safe{display:none}#MassCatModal .oo-ui-processDialog-location{padding-left:15px!important;text-align:left}#MassCat-updates-container{display:flex}#MassCat-updates-list{flex-grow:1}#MassCat-category-adder{text-align:center;flex-shrink:0;-webkit-user-select:none;user-select:none}#MassCat-add-category,#MassCat-remove-category{cursor:pointer;font-size:16px}#MassCat-remove-category.disabled{display:none}.MassCat-category-update,.MassCat-category-input-wrapper{padding-bottom:4px}.MassCat-category-input{width:90%}.MassCat-mode-select-wrapper{padding-bottom:4px}#MassCat-options-container{padding-bottom:8px}.MassCat-options-label{display:block}#MassCat-pages-container{padding-bottom:4px}.MassCat-pages-textarea{width:90%;height:120px}.MassCat-logger{font-weight:700;margin:8px 30px 8px 8px;padding:10px;color:#222;border:1px solid #000}#MassCat-status-container{background-color:#fffbe6}#MassCat-errors-container{background-color:#ffbfbf}.MassCat-hidden{display:none}.MassCat-fading-in{animation:MassCat-fading-in .3s linear}.MassCat-fading-out{animation:MassCat-fading-out .3s linear}@keyframes MassCat-fading-in{0%{opacity:0}to{opacity:1}}@keyframes MassCat-fading-out{0%{opacity:1}to{opacity:0}}"]},{},{},null]}))})(mediaWiki);
