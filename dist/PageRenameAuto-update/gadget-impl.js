(function(o){["sysop","bureaucrat","global-admin"].some(function(s){return(o.config.get("wgUserRights")||[]).indexOf(s)>-1})&&(o.loader.getState("ext.gadget.store.FandoomUiUtilsDorui")===null&&o.loader.load("https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@1bb78aaab64521129863a64533a7a15f4a77738d/dist/FandoomUiUtilsDorui/gadget-impl.js"),o.loader.getState("ext.gadget.store.PowertoolsPlacement")===null&&o.loader.load("https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@1bb78aaab64521129863a64533a7a15f4a77738d/dist/PowertoolsPlacement/gadget-impl.js"),o.loader.impl(function(){return["ext.gadget.store.PageRenameAuto-update@32e3f646",function(s,R,A,k){(function(){"use strict";if(window.PRA)return;var e={started:!1,options:window.PRAoptions||{},wg:o.config.get(["wgCanonicalSpecialPageName","wgNamespaceIds","wgNamespaceNumber","wgPageName"]),updateStatus:function(n,t){if(s("#PRAStatus").length===0)return!1;var a=t;if(typeof n=="string")a=n;else if(typeof n=="boolean")s("#liveLoader").css("display",n?"inline-block":"none");else return!1;return typeof a=="string"&&s("#PRAStatus").html(" "+a),!0},start:function(n){if(e.started)return!1;e.started=!0,e.updateStatus(!0,e.i18n.msg("processing").escape()),s("#PRAprocess").css("display","none"),e.toggleInputs(!1),e.oldName=o.util.getParamValue("pagename"),e.newName=s("#wpNewTitleMain").val(),e.reason=s("#wpReason").val(),e.pageKey=[],e.api.get({action:"query",prop:"revisions",rvprop:"content",titles:e.newName}).then(function(t){if(t.query.pages[-1])return e.getUsage(e.oldName);e.started=!1,e.updateStatus(!1,e.i18n.msg("destInUse").escape()),e.toggleInputs(!0),typeof n=="function"&&n(!1,"destinuse")}).then(function(t){if(t){var a=t.query.embeddedin,i=t.query.backlinks,u=t.query.categorymembers||[],r=t.query.imageusage||[],l=a.concat(i).concat(u).concat(r);console.log("Usage successfully retrieved"),l.length>0?(e.queueData=l.map(function(c){return c.title}),e.pageKey=[],e.updateStatus(!1,e.i18n.msg("successful").escape()),e.started=!1,e.toggleInputs(!0),s("#PRAprocess").css("display","inline-block"),e.updateQueueListing()):(e.started=!1,e.updateStatus(!1,e.i18n.msg("notUsed").escape()),e.toggleInputs(!0),typeof n=="function"&&n(!1,"filenotused"))}})},getUsage:function(n){var t={action:"query",list:"backlinks|embeddedin",bltitle:n,bllimit:"max",eititle:n,eilimit:"max"};return o.util.getParamValue("namespace")==="14"?(t.list+="|categorymembers",t.cmtitle=n,t.cmlimit="max"):o.util.getParamValue("namespace")==="6"&&(t.list+="|imageusage",t.iutitle=n,t.iulimit="max"),e.api.get(t)},processQueue:function(){if(e.started)return!1;e.started=!0,e.toggleInputs(!1),e.requestCompleted=[],e.pageData=[],e.updateStatus(!0,e.i18n.msg("processing").escape()),e.movePage(function(){e.processPageContent(function(){var n=window.dev.dorui;e.queueData=[],e.updateStatus(!1,e.i18n.msg("successful").escape()+" "+n.a({attrs:{href:o.util.getUrl(e.newName),target:"_blank"},text:e.i18n.msg("linkNewPage").plain()}).outerHTML),e.updateQueueListing()})})},processPageContent:function(n){for(var t=0;t<e.queueData.length;t++)e.requestCompleted[t]=!1;var a=[];console.log("Getting page contents");for(var i=0;i<Math.floor(e.queueData.length/500)+1;i++){for(var u=[],r=i*500;r<i*500+500&&r<e.queueData.length;r++)u.push(e.queueData[r]);if(u.length===0)break;for(;u.length>0;)a.push(e.api.post({action:"query",prop:"revisions",rvprop:"content",titles:u.splice(0,50)}).then(e.processPageCallback))}s.when.apply(this,a).then(function(){console.log("Page contents retrieved and saved. Begin processing page content.");var l=o.util.escapeRegExp(e.oldName).replace(/( |_)/g,"[ _]*?");l.slice(0,1).match(/[A-Za-z]/i)&&(l="["+l.slice(0,1).toUpperCase()+l.slice(0,1).toLowerCase()+"]"+l.slice(1));var c=Object.entries(e.wg.wgNamespaceIds).flatMap(function(g){if(g[1]!==6)return[];var d=o.util.escapeRegExp(g[0])+":";return d="["+d.slice(0,1).toUpperCase()+d.slice(0,1).toLowerCase()+"]"+d.slice(1),[d]}),m=!1;c.some(function(g){return l.startsWith(g)})&&(l="("+c.join("|")+")?"+l.slice(l.indexOf(":")+1),m=!0,e.newNameWithoutNamespace=e.newName.slice(e.newName.indexOf(":")+1));var f=new RegExp("(:?|=[ ]*?|\\||\\[|\\{)\\s*"+l+"\\s*(.*?\\n|[ ]*?\\||\\]|\\})","g"),x=new RegExp(l,"g");e.pageData.forEach(function(g){if(g.content.search(f)===-1)e.failedLog(g.title);else{g.changed=!0,console.log(e.oldName,"replaced on page",g.title);for(var d;(d=f.exec(g.content))!==null;){var y=m&&!d[2]?e.newNameWithoutNamespace:e.newName,b=d[0].replace(x,y);g.content=g.content.replace(d[0],b),f.lastIndex+=b.length-d[0].length}}}),console.log("Begin submitting pages");var h=window.dev.dorui;s(".PRAinfo").append(h.div({attrs:{id:"PRAQueueProgress"},child:h.div({attrs:{id:"PRAProgressInd"}})})),e.queueProgress=0;var p=0,L=setInterval(function(){e.pageData[p].changed===!0?e.submitChangedPages(p,n):e.requestCompleted[p]=!0,p++,p===e.pageData.length&&clearInterval(L)},e.options.interval||500)})},processPageCallback:function(n){for(var t in n.query.pages){var a=e.queueData.indexOf(n.query.pages[t].title);e.pageData[a]={title:e.queueData[a],content:n.query.pages[t].revisions[0]["*"],changed:!1}}},submitChangedPages:function(n,t){var a=e.pageData[n];e.api.postWithEditToken({action:"edit",title:a.title,summary:e.options.editSummary||e.i18n.inContentLang().msg("summary").plain(),text:a.content,minor:!0,nocreate:!0,redirect:!1,bot:!0}).then(function(){e.requestCompleted[n]=!0,console.log("Posted page",a.title),s("#PRAProgressInd").css("width",++e.queueProgress/e.pageData.length*100+"%"),e.requestCompleted.indexOf(!1)===-1&&(e.started=!1,s("#PRAQueueProgress").remove(),typeof t=="function"&&t())}).fail(function(i){alert(e.i18n.msg("notSubmitted",a.title,i).plain()),e.failedLog(a.title)})},movePage:function(n){e.api.postWithEditToken({action:"move",from:e.oldName,to:e.newName,reason:e.reason,movetalk:!1,noredirect:!0,ignorewarnings:!0}).then(function(){console.log("Moved page",e.oldName),typeof n=="function"&&n()}).fail(function(t){var a=e.i18n.msg("articleExistsPrompt",e.oldName,e.newName,t).plain();if(t==="articleexists"||t==="invalidtitle"){var i=prompt(a+`
`+e.i18n.msg("anotherDestName".plain()));i?(e.newName=i,e.movePage(n)):(e.started=!1,e.toggleInputs(!0))}else alert(a),e.started=!1,e.toggleInputs(!0)})},toggleInputs:function(n){s("#wpNewTitleMain, #wpReason").attr("disabled",n===!1)},failedLog:function(n){var t=window.dev.dorui;s("#PRAFailedLog").append(t.div({child:t.a({attrs:{href:o.util.getUrl(n),target:"_blank"},text:n})}))},updateQueueListing:function(){var n=window.dev.dorui;if(!e.queueData||e.queueData.length<1)return s("#PRAQueue").html(n.div({text:e.i18n.msg("nothingInQueue").plain()})),s("#PRAQueueLengthBox").text("0"),!1;s("#PRAQueue").html(e.queueData.map(function(t){return n.div({attrs:{href:o.util.getUrl(t),target:"_blank"},text:t})})),s("#PRAQueueLengthBox").text(e.queueData.length)},labelAndInput:function(n,t,a){return n.tr({children:[n.td({classes:["mw-label"],text:e.i18n.msg(t).plain()}),n.td({classes:["mw-input"],child:a})]})},createActionButton:function(n,t,a){a=a||{};var i=new OO.ui.ButtonWidget({label:a.label,title:a.label,flags:a.flags,icon:a.icon,iconTitle:a.label});return i=i.$element,i.attr("id",n),a.style&&i.css(a.style),i.on("click",t),i[0]},initialize:function(n){var t=window.dev.dorui;e.api=new o.Api,e.i18n=v(n);var a=e.i18n;if(e.wg.wgCanonicalSpecialPageName==="Blankpage"&&o.util.getParamValue("blankspecial")==="pageusageupdate"){var i=o.util.getParamValue("pagename");s("#firstHeading").text(a.msg("header",i).plain()),s("#bodyContent").html(t.frag([t.p({html:a.msg("infoText").parse()}),t.p({html:a.msg("notMovedNote").parse()}),t.p({html:a.msg("warning").parse()}),t.fieldset({children:[t.legend({text:a.msg("fieldTitle").plain()}),t.table({attrs:{id:"mw-renamepage-table"},children:[e.labelAndInput(t,"currentName",t.a({attrs:{href:o.util.getUrl(i)},text:i})),e.labelAndInput(t,"newNameField",t.input({attrs:{name:"wpNewTitleMain",value:i,type:"text",id:"wpNewTitleMain",maxlength:255}})),e.labelAndInput(t,"reason",t.textarea({attrs:{name:"wpReason",id:"wpReason",cols:60,rows:2,maxlength:255}})),t.tr({children:[t.td({html:"&#160;"}),t.td({classes:["mw-submit"],children:[this.createActionButton("PRAstart",e.start,{label:a.msg("populateListButton").plain(),flags:["progressive","primary"]}),this.createActionButton("PRAprocess",e.processQueue,{label:a.msg("processQueueButton").plain(),flags:["progressive","primary"],style:{display:"none"}}),t.span({attrs:{id:"liveLoader"},style:{display:"none"}}),t.span({attrs:{id:"PRAStatus"}})]})]}),e.labelAndInput(t,"queuedItems",t.div({attrs:{id:"PRAQueue"}})),t.tr({children:[t.td({classes:["mw-label"],html:"&#160;"}),t.td({classes:["mw-input","PRAinfo"],child:t.div({attrs:{id:"PRAQueueLength"},html:a.msg("pagesInQueue").escape().replace("$1",t.span({attrs:{id:"PRAQueueLengthBox"}}).outerHTML)})})]}),e.labelAndInput(t,"failedItems",t.div({attrs:{id:"PRAFailedLog"},text:a.msg("failedItemsInfo").plain()}))]})]})])),s("#liveLoader").append(s.createSpinner({size:"small",type:"inline"})),document.title=a.msg("title").plain(),e.updateQueueListing()}else{var u="ext.gadget.store.PowertoolsPlacement";o.loader.getState(u)!==null&&o.hook("dev.powertools.placement").add(function(r){r.addPortletLink(o.config.values.skin,{id:"t-page-rename-auto-update",href:o.util.getUrl("Special:BlankPage",{blankspecial:"pageusageupdate",pagename:e.wg.wgPageName,namespace:e.wg.wgNamespaceNumber}),label:a.msg("buttonText").plain(),tooltip:"PageRenameAuto-update"})})}},preload:function(){s.when(P(),o.loader.using(["mediawiki.api","mediawiki.user","mediawiki.util","jquery.spinner","oojs","oojs-ui"])).then(this.initialize.bind(this))}};function v(n){var t=o.Message;t.prototype.constructor=o.Message.prototype.constructor;var a={_i18nLoader:n,msg:function(){var i=Array.prototype.slice.call(arguments);if(i.length!==0){var u=i.shift();return new t(this._i18nLoader.getMessages(),u,i)}}};return["setTempLang","setDefaultLang"].forEach(function(i){a[i]=a._i18nLoader[i].bind(a._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(i){a[i]=a._i18nLoader[i].bind(a)}),a}function P(){var n=new s.Deferred,t=new s.Deferred;function a(){var r=s.Deferred();return o.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(l){r.resolve(l("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(r.reject),r}function i(r){return r.loadMessages("PageRenameAuto-update",{})}function u(r){n.resolve(r)}return t.then(a).then(i).then(u).catch(function(r){console.error(r),n.resolve(w())}),o.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?t.resolve():s.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@1bb78aaab64521129863a64533a7a15f4a77738d/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){t.resolve()}).fail(t.reject),n}function w(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var n=new o.Map;n.set({buttonText:"Rename & update",summary:"Updating page links (automatic)",header:"Renaming page: $1",infoText:"Using the form below will rename a page and change the page names on pages that the page is used on. Be sure to check [[Special:WantedCategories|wanted categories]]. You are responsible for making sure that links continue to point where they are supposed to go.",notMovedNote:"Note that the page will <strong>not</strong> be moved if there is already a page at the new title.",warning:"<strong>Warning!</strong> This can be drastic and unexpected for a popular page; please be sure you understand the consequences of this before proceeding.",fieldTitle:"Rename page & update usage",currentName:"Current name:",newNameField:"New name:",reason:"Reason:",populateListButton:"Populate list",queuedItems:"Queued items:",nothingInQueue:"There is currently nothing in the queue.",pagesInQueue:"Pages in queue: $1",failedItems:"Failed items:",failedItemsInfo:"Failed items appear here after execution. Note that pages that the page is transcluded through a template on will also appear here falsely.",processing:"Processing...",successful:"Successful!",processQueueButton:"Process queue",linkNewPage:"Link",notSubmitted:'The page "$1" could not be submitted because of error code: $2. Please update the link(s) on that page manually.',articleExistsPrompt:'The page "$1" was unable to be moved to "$2" for reason: $3.',anotherDestName:"Please enter another destination name for this page, or cancel the moving.",notUsed:"Page not linked on any pages.",destInUse:"Destination name already in use.",title:"Page Rename Auto-Update"}),o.Message.prototype.escape===void 0&&(o.Message.prototype.escape=o.Message.prototype.escaped);var t={getMessages:function(){return n}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(a){t[a]=s.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){t[a]=function(){return this}}),t}e.preload(),window.PRA=e})()},{css:["#PRAQueueProgress{border:2px solid #000;box-sizing:border-box;float:right;height:17px;margin:6px 5px 0 0;width:200px}.theme-dark #PRAQueueProgress{border-color:#fff}#PRAProgressInd{background-color:green;float:left;height:100%;width:0%}.theme-dark #PRAProgressInd{background-color:#006400}#PRAFailedLog div:nth-child(odd){background-color:#8b0000}#PRAQueue div:nth-child(odd){background-color:#d3d3d3}.theme-dark #PRAQueue div:nth-child(odd){background-color:#333}.mw-input a{font-weight:700}#PRAstart{margin-left:0}#PRAprocess{margin-left:5px}#PRAStatus{font-weight:700}#PRAQueue{background-color:#fff;border:1px solid #000;box-sizing:border-box;float:left;font-weight:700;height:300px;overflow:scroll;width:798px}.theme-dark #PRAQueue{background-color:#000;border-color:#fff}#PRAQueueLength{float:left;font-weight:700;margin:5px 15px 0 0}#PRAFailedLog{background-color:#ffbfbf;color:#000;border:1px solid #000;box-sizing:border-box;font-weight:700;height:150px;margin:5px auto 0;overflow:scroll;width:798px}.theme-dark #PRAFailedLog{background-color:#8b0000;border-color:#fff}#wpNewTitleMain{width:100%;box-sizing:border-box}"]},{},{},null]}))})(mediaWiki);
