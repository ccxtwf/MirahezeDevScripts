(function(){"use strict";if(window.PRA)return;var e={started:!1,options:window.PRAoptions||{},wg:mw.config.get(["wgCanonicalSpecialPageName","wgNamespaceIds","wgNamespaceNumber","wgPageName"]),updateStatus:function(n,t){if($("#PRAStatus").length===0)return!1;var a=t;if(typeof n=="string")a=n;else if(typeof n=="boolean")$("#liveLoader").css("display",n?"inline-block":"none");else return!1;return typeof a=="string"&&$("#PRAStatus").html(" "+a),!0},start:function(n){if(e.started)return!1;e.started=!0,e.updateStatus(!0,e.i18n.msg("processing").escape()),$("#PRAprocess").css("display","none"),e.toggleInputs(!1),e.oldName=mw.util.getParamValue("pagename"),e.newName=$("#wpNewTitleMain").val(),e.reason=$("#wpReason").val(),e.pageKey=[],e.api.get({action:"query",prop:"revisions",rvprop:"content",titles:e.newName}).then(function(t){if(t.query.pages[-1])return e.getUsage(e.oldName);e.started=!1,e.updateStatus(!1,e.i18n.msg("destInUse").escape()),e.toggleInputs(!0),typeof n=="function"&&n(!1,"destinuse")}).then(function(t){if(t){var a=t.query.embeddedin,s=t.query.backlinks,o=t.query.categorymembers||[],i=t.query.imageusage||[],r=a.concat(s).concat(o).concat(i);console.log("Usage successfully retrieved"),r.length>0?(e.queueData=r.map(function(d){return d.title}),e.pageKey=[],e.updateStatus(!1,e.i18n.msg("successful").escape()),e.started=!1,e.toggleInputs(!0),$("#PRAprocess").css("display","inline-block"),e.updateQueueListing()):(e.started=!1,e.updateStatus(!1,e.i18n.msg("notUsed").escape()),e.toggleInputs(!0),typeof n=="function"&&n(!1,"filenotused"))}})},getUsage:function(n){var t={action:"query",list:"backlinks|embeddedin",bltitle:n,bllimit:"max",eititle:n,eilimit:"max"};return mw.util.getParamValue("namespace")==="14"?(t.list+="|categorymembers",t.cmtitle=n,t.cmlimit="max"):mw.util.getParamValue("namespace")==="6"&&(t.list+="|imageusage",t.iutitle=n,t.iulimit="max"),e.api.get(t)},processQueue:function(){if(e.started)return!1;e.started=!0,e.toggleInputs(!1),e.requestCompleted=[],e.pageData=[],e.updateStatus(!0,e.i18n.msg("processing").escape()),e.movePage(function(){e.processPageContent(function(){var n=window.dev.dorui;e.queueData=[],e.updateStatus(!1,e.i18n.msg("successful").escape()+" "+n.a({attrs:{href:mw.util.getUrl(e.newName),target:"_blank"},text:e.i18n.msg("linkNewPage").plain()}).outerHTML),e.updateQueueListing()})})},processPageContent:function(n){for(var t=0;t<e.queueData.length;t++)e.requestCompleted[t]=!1;var a=[];console.log("Getting page contents");for(var s=0;s<Math.floor(e.queueData.length/500)+1;s++){for(var o=[],i=s*500;i<s*500+500&&i<e.queueData.length;i++)o.push(e.queueData[i]);if(o.length===0)break;for(;o.length>0;)a.push(e.api.post({action:"query",prop:"revisions",rvprop:"content",titles:o.splice(0,50)}).then(e.processPageCallback))}$.when.apply(this,a).then(function(){console.log("Page contents retrieved and saved. Begin processing page content.");var r=mw.util.escapeRegExp(e.oldName).replace(/( |_)/g,"[ _]*?");r.slice(0,1).match(/[A-Za-z]/i)&&(r="["+r.slice(0,1).toUpperCase()+r.slice(0,1).toLowerCase()+"]"+r.slice(1));var d=Object.entries(e.wg.wgNamespaceIds).flatMap(function(l){if(l[1]!==6)return[];var u=mw.util.escapeRegExp(l[0])+":";return u="["+u.slice(0,1).toUpperCase()+u.slice(0,1).toLowerCase()+"]"+u.slice(1),[u]}),c=!1;d.some(function(l){return r.startsWith(l)})&&(r="("+d.join("|")+")?"+r.slice(r.indexOf(":")+1),c=!0,e.newNameWithoutNamespace=e.newName.slice(e.newName.indexOf(":")+1));var p=new RegExp("(:?|=[ ]*?|\\||\\[|\\{)\\s*"+r+"\\s*(.*?\\n|[ ]*?\\||\\]|\\})","g"),P=new RegExp(r,"g");e.pageData.forEach(function(l){if(l.content.search(p)===-1)e.failedLog(l.title);else{l.changed=!0,console.log(e.oldName,"replaced on page",l.title);for(var u;(u=p.exec(l.content))!==null;){var b=c&&!u[2]?e.newNameWithoutNamespace:e.newName,f=u[0].replace(P,b);l.content=l.content.replace(u[0],f),p.lastIndex+=f.length-u[0].length}}}),console.log("Begin submitting pages");var m=window.dev.dorui;$(".PRAinfo").append(m.div({attrs:{id:"PRAQueueProgress"},child:m.div({attrs:{id:"PRAProgressInd"}})})),e.queueProgress=0;var g=0,L=setInterval(function(){e.pageData[g].changed===!0?e.submitChangedPages(g,n):e.requestCompleted[g]=!0,g++,g===e.pageData.length&&clearInterval(L)},e.options.interval||500)})},processPageCallback:function(n){for(var t in n.query.pages){var a=e.queueData.indexOf(n.query.pages[t].title);e.pageData[a]={title:e.queueData[a],content:n.query.pages[t].revisions[0]["*"],changed:!1}}},submitChangedPages:function(n,t){var a=e.pageData[n];e.api.postWithEditToken({action:"edit",title:a.title,summary:e.options.editSummary||e.i18n.inContentLang().msg("summary").plain(),text:a.content,minor:!0,nocreate:!0,redirect:!1,bot:!0}).then(function(){e.requestCompleted[n]=!0,console.log("Posted page",a.title),$("#PRAProgressInd").css("width",++e.queueProgress/e.pageData.length*100+"%"),e.requestCompleted.indexOf(!1)===-1&&(e.started=!1,$("#PRAQueueProgress").remove(),typeof t=="function"&&t())}).fail(function(s){alert(e.i18n.msg("notSubmitted",a.title,s).plain()),e.failedLog(a.title)})},movePage:function(n){e.api.postWithEditToken({action:"move",from:e.oldName,to:e.newName,reason:e.reason,movetalk:!1,noredirect:!0,ignorewarnings:!0}).then(function(){console.log("Moved page",e.oldName),typeof n=="function"&&n()}).fail(function(t){var a=e.i18n.msg("articleExistsPrompt",e.oldName,e.newName,t).plain();if(t==="articleexists"||t==="invalidtitle"){var s=prompt(a+`
`+e.i18n.msg("anotherDestName".plain()));s?(e.newName=s,e.movePage(n)):(e.started=!1,e.toggleInputs(!0))}else alert(a),e.started=!1,e.toggleInputs(!0)})},toggleInputs:function(n){$("#wpNewTitleMain, #wpReason").attr("disabled",n===!1)},failedLog:function(n){var t=window.dev.dorui;$("#PRAFailedLog").append(t.div({child:t.a({attrs:{href:mw.util.getUrl(n),target:"_blank"},text:n})}))},updateQueueListing:function(){var n=window.dev.dorui;if(!e.queueData||e.queueData.length<1)return $("#PRAQueue").html(n.div({text:e.i18n.msg("nothingInQueue").plain()})),$("#PRAQueueLengthBox").text("0"),!1;$("#PRAQueue").html(e.queueData.map(function(t){return n.div({attrs:{href:mw.util.getUrl(t),target:"_blank"},text:t})})),$("#PRAQueueLengthBox").text(e.queueData.length)},labelAndInput:function(n,t,a){return n.tr({children:[n.td({classes:["mw-label"],text:e.i18n.msg(t).plain()}),n.td({classes:["mw-input"],child:a})]})},createActionButton:function(n,t,a){a=a||{};var s=new OO.ui.ButtonWidget({label:a.label,title:a.label,flags:a.flags,icon:a.icon,iconTitle:a.label});return s=s.$element,s.attr("id",n),a.style&&s.css(a.style),s.on("click",t),s[0]},initialize:function(n){var t=window.dev.dorui;e.api=new mw.Api,e.i18n=h(n);var a=e.i18n;if(e.wg.wgCanonicalSpecialPageName==="Blankpage"&&mw.util.getParamValue("blankspecial")==="pageusageupdate"){var s=mw.util.getParamValue("pagename");$("#firstHeading").text(a.msg("header",s).plain()),$("#bodyContent").html(t.frag([t.p({html:a.msg("infoText").parse()}),t.p({html:a.msg("notMovedNote").parse()}),t.p({html:a.msg("warning").parse()}),t.fieldset({children:[t.legend({text:a.msg("fieldTitle").plain()}),t.table({attrs:{id:"mw-renamepage-table"},children:[e.labelAndInput(t,"currentName",t.a({attrs:{href:mw.util.getUrl(s)},text:s})),e.labelAndInput(t,"newNameField",t.input({attrs:{name:"wpNewTitleMain",value:s,type:"text",id:"wpNewTitleMain",maxlength:255}})),e.labelAndInput(t,"reason",t.textarea({attrs:{name:"wpReason",id:"wpReason",cols:60,rows:2,maxlength:255}})),t.tr({children:[t.td({html:"&#160;"}),t.td({classes:["mw-submit"],children:[this.createActionButton("PRAstart",e.start,{label:a.msg("populateListButton").plain(),flags:["progressive","primary"]}),this.createActionButton("PRAprocess",e.processQueue,{label:a.msg("processQueueButton").plain(),flags:["progressive","primary"],style:{display:"none"}}),t.span({attrs:{id:"liveLoader"},style:{display:"none"}}),t.span({attrs:{id:"PRAStatus"}})]})]}),e.labelAndInput(t,"queuedItems",t.div({attrs:{id:"PRAQueue"}})),t.tr({children:[t.td({classes:["mw-label"],html:"&#160;"}),t.td({classes:["mw-input","PRAinfo"],child:t.div({attrs:{id:"PRAQueueLength"},html:a.msg("pagesInQueue").escape().replace("$1",t.span({attrs:{id:"PRAQueueLengthBox"}}).outerHTML)})})]}),e.labelAndInput(t,"failedItems",t.div({attrs:{id:"PRAFailedLog"},text:a.msg("failedItemsInfo").plain()}))]})]})])),$("#liveLoader").append($.createSpinner({size:"small",type:"inline"})),document.title=a.msg("title").plain(),e.updateQueueListing()}else{var o="ext.gadget.store.PowertoolsPlacement";mw.loader.getState(o)!==null&&mw.hook("dev.powertools.placement").add(function(i){i.addPortletLink(mw.config.values.skin,{id:"t-page-rename-auto-update",href:mw.util.getUrl("Special:BlankPage",{blankspecial:"pageusageupdate",pagename:e.wg.wgPageName,namespace:e.wg.wgNamespaceNumber}),label:a.msg("buttonText").plain(),tooltip:"PageRenameAuto-update"})})}},preload:function(){$.when(w(),mw.loader.using(["mediawiki.api","mediawiki.user","mediawiki.util","jquery.spinner","oojs","oojs-ui"])).then(this.initialize.bind(this))}};function h(n){var t=mw.Message;t.prototype.constructor=mw.Message.prototype.constructor;var a={_i18nLoader:n,msg:function(){var s=Array.prototype.slice.call(arguments);if(s.length!==0){var o=s.shift();return new t(this._i18nLoader.getMessages(),o,s)}}};return["setTempLang","setDefaultLang"].forEach(function(s){a[s]=a._i18nLoader[s].bind(a._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(s){a[s]=a._i18nLoader[s].bind(a)}),a}function w(){var n=new $.Deferred,t=new $.Deferred;function a(){var i=$.Deferred();return mw.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(r){i.resolve(r("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(i.reject),i}function s(i){return i.loadMessages("PageRenameAuto-update",{})}function o(i){n.resolve(i)}return t.then(a).then(s).then(o).catch(function(i){console.error(i),n.resolve(v())}),mw.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?t.resolve():$.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@v0.0.4/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){t.resolve()}).fail(t.reject),n}function v(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var n=new mw.Map;n.set({buttonText:"Rename & update",summary:"Updating page links (automatic)",header:"Renaming page: $1",infoText:"Using the form below will rename a page and change the page names on pages that the page is used on. Be sure to check [[Special:WantedCategories|wanted categories]]. You are responsible for making sure that links continue to point where they are supposed to go.",notMovedNote:"Note that the page will <strong>not</strong> be moved if there is already a page at the new title.",warning:"<strong>Warning!</strong> This can be drastic and unexpected for a popular page; please be sure you understand the consequences of this before proceeding.",fieldTitle:"Rename page & update usage",currentName:"Current name:",newNameField:"New name:",reason:"Reason:",populateListButton:"Populate list",queuedItems:"Queued items:",nothingInQueue:"There is currently nothing in the queue.",pagesInQueue:"Pages in queue: $1",failedItems:"Failed items:",failedItemsInfo:"Failed items appear here after execution. Note that pages that the page is transcluded through a template on will also appear here falsely.",processing:"Processing...",successful:"Successful!",processQueueButton:"Process queue",linkNewPage:"Link",notSubmitted:'The page "$1" could not be submitted because of error code: $2. Please update the link(s) on that page manually.',articleExistsPrompt:'The page "$1" was unable to be moved to "$2" for reason: $3.',anotherDestName:"Please enter another destination name for this page, or cancel the moving.",notUsed:"Page not linked on any pages.",destInUse:"Destination name already in use.",title:"Page Rename Auto-Update"}),mw.Message.prototype.escape===void 0&&(mw.Message.prototype.escape=mw.Message.prototype.escaped);var t={getMessages:function(){return n}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(a){t[a]=$.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(a){t[a]=function(){return this}}),t}e.preload(),window.PRA=e})();
