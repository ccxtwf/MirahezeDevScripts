(function(i,l){var y=l.config.get(["wgCanonicalNamespace","wgCanonicalSpecialPageName","wgPageName","wgUserGroups","wgRevisionId","wgIsRedirect"]),C=["bureaucrat","sysop","global-admin"],A="rgb(20, 220, 23)",L="rgb(220, 20, 60)",k="rgb(100, 149, 237)",I="black",v,c,f,u,p,E,g,h,P;if(window.AjaxBatchRedirectLoaded)return;window.AjaxBatchRedirectLoaded=!0;function _(e){console.log(c.msg(e).plain()),l.notify(c.msg(e).plain(),{type:"error"})}function m(e,a,n,t){P.append(i("<div>").css("color",a).text(c.msg(e,n,t).escape()))}function T(e,a){return new Promise(function(n){v.postWithEditToken({action:"edit",watchlist:"nochange",title:e,minor:!0,bot:!0,text:"#REDIRECT [["+a.charAt(0).toUpperCase()+a.slice(1)+"]]"}).done(function(t){t.error&&console.warn(t.error),n({error:t.error?"redirectfail":!1})}).fail(function(t){console.warn(t),n({error:"redirectfail"})})})}function S(e,a){return new Promise(function(n){v.postWithEditToken({action:"delete",watchlist:"nochange",title:e,reason:c.msg("deleteReason").plain()}).done(function(t){if(t.error){console.warn(t.error),n({error:"deleteFail"});return}n(T(e,a))}).fail(function(t){console.warn(t),n({error:"deleteFail"})})})}function R(e){return new Promise(function(a){v.get({action:"query",titles:e.flat().join("|"),prop:"info"}).done(function(n){n.error&&console.warn(n.error),a(n.error?!1:n.query.pages)}).fail(function(n){console.warn(n),a(!1)})})}function b(e,a,n,t,o){return new Promise(function(r){var d=e.slice(n,n+5);t=t.concat(d.map(function(s){return a(s[0],s[1])})),n+5>=e.length?r(t):(E.empty().append(i("<div>").css("color",A).text(c.msg("inCooldown",t.length,e.length).escape())),setTimeout(function(){b(e,a,n+5,t,o).then(function(s){r(s)})},o))})}function U(e,a){return new Promise(function(n){b(e,S,0,[],1e4).then(function(t){Promise.allSettled(t).then(function(o){for(var r in o)o[r].reason||o[r].value.error==="redirectfail"?(m("consoleRedirectFail",L,e[r][0],e[r][1]),a.push(e[r]),o[r].reason&&console.warn(o[r].reason)):o[r].value.error==="deleteFail"&&(m("consoleDeleteFail",L,e[r][0],e[r][1]),a.push(e[r]));n(!0)})})})}function j(e,a){return new Promise(function(n){b(e,T,0,[],5e3).then(function(t){Promise.allSettled(t).then(function(o){for(var r in o)(o[r].reason||o[r].value.error==="redirectfail")&&(m("consoleRedirectFail",L,e[r][0],e[r][1]),a.push(e[r]),o[r].reason&&console.warn(o[r].reason));n(!0)})})})}function N(e){R(e).then(function(a){if(!a){_("queryError");return}var n={},t=[],o=[],r=[],d=1,s,F=function(){if(--d===0){var w=t.length+o.length-r.length;P.append(i("<div>").css("color",I).text(c.msg("finished",w).escape())),g.val(r.map(function(M){return M[0]}).join(`
`)),h.val(r.map(function(M){return M[1]}).join(`
`)),E.empty(),g.removeAttr("disabled"),h.removeAttr("disabled"),u=!1}};for(s in a)n[a[s].title]=a[s];for(s in e){var D=n[e[s][0]];D.ns===6&&D.missing!==""&&D.redirect!==""?o.push(e[s]):t.push(e[s])}if(o.length>0)if(y.wgUserGroups.some(function(w){return C.includes(w)})){var H=confirm(c.msg("confirmDeletePages",o.map(function(w){return w[0]}).join(`
`)).plain());if(H)d++,U(o,r).then(F);else for(s in o)m("consoleDeleteSkipped",k,o[s][0],o[s][1]),r.push(o[s])}else for(s in o)m("consoleDeleteNoPerm",k,o[s][0],o[s][1]),r.push(o[s]);j(t,r).then(F)})}function G(){if(!u){u=!0;for(var e=g.val().split(`
`),a=h.val().split(`
`),n=[],t=0;t<Math.max(e.length,a.length);t++){var o=(e[t]||"").replaceAll("_"," ").trim(),r=(a[t]||"").replaceAll("_"," ").trim();if(!(o===""&&r===""))if(o===""||r===""){alert(c.msg("pageCouplingError",t+1,o,r).plain()),u=!1;return}else n.push([o,r])}n.length>0?(g.attr("disabled",""),h.attr("disabled",""),P.empty(),N(n)):u=!1}}function V(){return i("<form>").append(i("<fieldset>").append(i("<p>",{text:c.msg("inputInstructions").plain()}),i("<p>",{id:"form-progress"}),i("<div>",{id:"form-main-wrapper"}).append(i("<div>").append(i("<p>",{text:c.msg("inputPagesFrom").plain()+":"}),i("<textarea>",{id:"text-pages-from"})),i("<div>").append(i("<p>",{text:c.msg("inputPagesTo").plain()+":"}),i("<textarea>",{id:"text-pages-to"}))),i("<p>",{text:c.msg("errorsForm").plain()+":"}),i("<div>",{id:"text-error-output"}))).prop("outerHTML")}function B(){if(f){f.show();return}f=new window.dev.modal.Modal({content:V(),id:"batchredirect-form",size:"large",title:c.msg("modalTitle").escape(),buttons:[{id:"batchredirect-start",text:c.msg("initiate").escape(),primary:!0,event:"start"}],events:{start:G}}),f.create(),p=i("#batchredirect-form"),E=p.find("#form-progress"),g=p.find("#text-pages-from"),h=p.find("#text-pages-to"),P=p.find("#text-error-output"),f.show()}function W(){v=new l.Api,l.libs.PowertoolsPlacement.addPortletLink(l.config.values.skin,{id:"t-batchredirect",href:"#",label:c.msg("toolsTitle").plain(),tooltip:"AjaxBatchRedirect",onClick:B})}var q=3;function x(){--q===0&&l.loader.using(["mediawiki.api","mediawiki.user"]).then(W)}l.hook("dev.modal").add(x),l.hook("dev.powertools.placement").add(x),Q().then(function(e){c=O(e),x()});function O(e){var a=l.Message;a.prototype.constructor=l.Message.prototype.constructor;var n={_i18nLoader:e,msg:function(){var t=Array.prototype.slice.call(arguments);if(t.length!==0){var o=t.shift();return new a(this._i18nLoader.getMessages(),o,t)}}};return["setTempLang","setDefaultLang"].forEach(function(t){n[t]=n._i18nLoader[t].bind(n._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(t){n[t]=n._i18nLoader[t].bind(n)}),n}function Q(){var e=new i.Deferred,a=new i.Deferred;function n(){var r=i.Deferred();return l.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(d){r.resolve(d("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(r.reject),r}function t(r){return r.loadMessages("AjaxBatchRedirect",{})}function o(r){e.resolve(r)}return a.then(n).then(t).then(o).catch(function(r){console.error(r),e.resolve(z())}),l.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?a.resolve():i.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@${NEW_TAG}/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){a.resolve()}).fail(a.reject),e}function z(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new l.Map;e.set({toolsTitle:"Batch Redirect",modalTitle:"Ajax Batch Redirect",inputInstructions:"Put the name of each page on a separate line. Each line on the left side table will be redirected to the corresponding line on the right side.",inputPagesFrom:"Pages to redirect from",inputPagesTo:"Pages to redirect to",errorsForm:"Any errors encountered will appear below",initiate:"Initiate",deleteReason:"Reason: Making redirect",finished:"Finished. $1 pages redirected. Failed pages are reinserted to the input boxes.",confirmDeletePages:`Delete the following file pages to make way for redirect?

$1`,pageCouplingError:`Cannot couple pages correctly. Please check that each line on the left panel corresponds to each line on the right panel.

Error on Line $1: from page $2, to page $3`,queryError:"Unexpected error on page info query.",inCooldown:"$1/$2 (in cooldown)",consoleRedirectFail:"Redirect edit failed: from page $1, to page $2.",consoleDeleteFail:"Failed to delete file page $1 for redirecting to $2.",consoleDeleteNoPerm:"Not enough permission to delete file page $1 for redirecting to $2.",consoleDeleteSkipped:"User skipped a file page redirect: from page $1, to page $2."}),l.Message.prototype.escape===void 0&&(l.Message.prototype.escape=l.Message.prototype.escaped);var a={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(n){a[n]=i.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(n){a[n]=function(){return this}}),a}})(jQuery,mediaWiki);
