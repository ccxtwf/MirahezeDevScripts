(function(p){p.loader.getState("ext.gadget.store.FandoomUiUtilsModal")===null&&p.loader.load("https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@dist/dist/FandoomUiUtilsModal/gadget-impl.js"),p.loader.getState("ext.gadget.store.PowertoolsPlacement")===null&&p.loader.load("https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@dist/dist/PowertoolsPlacement/gadget-impl.js"),p.loader.impl(function(){return["ext.gadget.store.AjaxBatchRedirect@c68a0d8f",function(K,D,X,Y){(function(a,c){var $=c.config.get(["wgCanonicalNamespace","wgCanonicalSpecialPageName","wgPageName","wgUserGroups","wgRevisionId","wgIsRedirect"]),A=["bureaucrat","sysop","global-admin"],C="rgb(20, 220, 23)",P="rgb(220, 20, 60)",U="rgb(100, 149, 237)",E="black",x,l,g,f,u,b,m,h,L;if(window.AjaxBatchRedirectLoaded)return;window.AjaxBatchRedirectLoaded=!0;function T(e){console.log(l.msg(e).plain()),c.notify(l.msg(e).plain(),{type:"error"})}function w(e,i,t,r){L.append(a("<div>").css("color",i).text(l.msg(e,t,r).escape()))}function R(e,i){return new Promise(function(t){x.postWithEditToken({action:"edit",watchlist:"nochange",title:e,minor:!0,bot:!0,text:"#REDIRECT [["+i.charAt(0).toUpperCase()+i.slice(1)+"]]"}).done(function(r){r.error&&console.warn(r.error),t({error:r.error?"redirectfail":!1})}).fail(function(r){console.warn(r),t({error:"redirectfail"})})})}function I(e,i){return new Promise(function(t){x.postWithEditToken({action:"delete",watchlist:"nochange",title:e,reason:l.msg("deleteReason").plain()}).done(function(r){if(r.error){console.warn(r.error),t({error:"deleteFail"});return}t(R(e,i))}).fail(function(r){console.warn(r),t({error:"deleteFail"})})})}function S(e){return new Promise(function(i){x.get({action:"query",titles:e.flat().join("|"),prop:"info"}).done(function(t){t.error&&console.warn(t.error),i(t.error?!1:t.query.pages)}).fail(function(t){console.warn(t),i(!1)})})}function y(e,i,t,r,o){return new Promise(function(n){var d=e.slice(t,t+5);r=r.concat(d.map(function(s){return i(s[0],s[1])})),t+5>=e.length?n(r):(b.empty().append(a("<div>").css("color",C).text(l.msg("inCooldown",r.length,e.length).escape())),setTimeout(function(){y(e,i,t+5,r,o).then(function(s){n(s)})},o))})}function B(e,i){return new Promise(function(t){y(e,I,0,[],1e4).then(function(r){Promise.allSettled(r).then(function(o){for(var n in o)o[n].reason||o[n].value.error==="redirectfail"?(w("consoleRedirectFail",P,e[n][0],e[n][1]),i.push(e[n]),o[n].reason&&console.warn(o[n].reason)):o[n].value.error==="deleteFail"&&(w("consoleDeleteFail",P,e[n][0],e[n][1]),i.push(e[n]));t(!0)})})})}function _(e,i){return new Promise(function(t){y(e,R,0,[],5e3).then(function(r){Promise.allSettled(r).then(function(o){for(var n in o)(o[n].reason||o[n].value.error==="redirectfail")&&(w("consoleRedirectFail",P,e[n][0],e[n][1]),i.push(e[n]),o[n].reason&&console.warn(o[n].reason));t(!0)})})})}function q(e){S(e).then(function(i){if(!i){T("queryError");return}var t={},r=[],o=[],n=[],d=1,s,M=function(){if(--d===0){var v=r.length+o.length-n.length;L.append(a("<div>").css("color",E).text(l.msg("finished",v).escape())),m.val(n.map(function(k){return k[0]}).join(`
`)),h.val(n.map(function(k){return k[1]}).join(`
`)),b.empty(),m.removeAttr("disabled"),h.removeAttr("disabled"),f=!1}};for(s in i)t[i[s].title]=i[s];for(s in e){var j=t[e[s][0]];j.ns===6&&j.missing!==""&&j.redirect!==""?o.push(e[s]):r.push(e[s])}if(o.length>0)if($.wgUserGroups.some(function(v){return A.includes(v)})){var J=confirm(l.msg("confirmDeletePages",o.map(function(v){return v[0]}).join(`
`)).plain());if(J)d++,B(o,n).then(M);else for(s in o)w("consoleDeleteSkipped",U,o[s][0],o[s][1]),n.push(o[s])}else for(s in o)w("consoleDeleteNoPerm",U,o[s][0],o[s][1]),n.push(o[s]);_(r,n).then(M)})}function z(){if(!f){f=!0;for(var e=m.val().split(`
`),i=h.val().split(`
`),t=[],r=0;r<Math.max(e.length,i.length);r++){var o=(e[r]||"").replaceAll("_"," ").trim(),n=(i[r]||"").replaceAll("_"," ").trim();if(!(o===""&&n===""))if(o===""||n===""){alert(l.msg("pageCouplingError",r+1,o,n).plain()),f=!1;return}else t.push([o,n])}t.length>0?(m.attr("disabled",""),h.attr("disabled",""),L.empty(),q(t)):f=!1}}function N(){return a("<form>").append(a("<fieldset>").append(a("<p>",{text:l.msg("inputInstructions").plain()}),a("<p>",{id:"form-progress"}),a("<div>",{id:"form-main-wrapper"}).append(a("<div>").append(a("<p>",{text:l.msg("inputPagesFrom").plain()+":"}),a("<textarea>",{id:"text-pages-from"})),a("<div>").append(a("<p>",{text:l.msg("inputPagesTo").plain()+":"}),a("<textarea>",{id:"text-pages-to"}))),a("<p>",{text:l.msg("errorsForm").plain()+":"}),a("<div>",{id:"text-error-output"}))).prop("outerHTML")}function V(){if(g){g.show();return}g=new window.dev.modal.Modal({content:N(),id:"batchredirect-form",size:"large",title:l.msg("modalTitle").escape(),buttons:[{id:"batchredirect-start",text:l.msg("initiate").escape(),primary:!0,event:"start"}],events:{start:z}}),g.create(),u=a("#batchredirect-form"),b=u.find("#form-progress"),m=u.find("#text-pages-from"),h=u.find("#text-pages-to"),L=u.find("#text-error-output"),g.show()}function W(){x=new c.Api,c.libs.PowertoolsPlacement.addPortletLink(c.config.values.skin,{id:"t-batchredirect",href:"#",label:l.msg("toolsTitle").plain(),tooltip:"AjaxBatchRedirect",onClick:V})}var G=3;function F(){--G===0&&c.loader.using(["mediawiki.api","mediawiki.user"]).then(W)}c.hook("dev.modal").add(F),c.hook("dev.powertools.placement").add(F),O().then(function(e){l=H(e),F()});function H(e){var i=c.Message;i.prototype.constructor=c.Message.prototype.constructor;var t={_i18nLoader:e,msg:function(){var r=Array.prototype.slice.call(arguments);if(r.length!==0){var o=r.shift();return new i(this._i18nLoader.getMessages(),o,r)}}};return["setTempLang","setDefaultLang"].forEach(function(r){t[r]=t._i18nLoader[r].bind(t._i18nLoader)}),["useLang","usePageLang","useContentLang","usePageViewLang","useUserLang","inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(r){t[r]=t._i18nLoader[r].bind(t)}),t}function O(){var e=new a.Deferred,i=new a.Deferred;function t(){var n=a.Deferred();return c.loader.using("ext.gadget.store.FandoomUtilsI18nLoader").done(function(d){n.resolve(d("ext.gadget.store.FandoomUtilsI18nLoader"))}).fail(n.reject),n}function r(n){return n.loadMessages("AjaxBatchRedirect",{})}function o(n){e.resolve(n)}return i.then(t).then(r).then(o).catch(function(n){console.error(n),e.resolve(Q())}),c.loader.getState("ext.gadget.store.FandoomUtilsI18nLoader")?i.resolve():a.ajax({dataType:"script",cache:!0,url:"https://cdn.jsdelivr.net/gh/ccxtwf/MirahezeDevScripts@dist/dist/FandoomUtilsI18nLoader/gadget-impl.js"}).done(function(){i.resolve()}).fail(i.reject),e}function Q(){console.warn("[FandoomUtilsI18nLoader] Failed to load messages. Using fallback messages instead.");var e=new c.Map;e.set({toolsTitle:"Batch Redirect",modalTitle:"Ajax Batch Redirect",inputInstructions:"Put the name of each page on a separate line. Each line on the left side table will be redirected to the corresponding line on the right side.",inputPagesFrom:"Pages to redirect from",inputPagesTo:"Pages to redirect to",errorsForm:"Any errors encountered will appear below",initiate:"Initiate",deleteReason:"Reason: Making redirect",finished:"Finished. $1 pages redirected. Failed pages are reinserted to the input boxes.",confirmDeletePages:`Delete the following file pages to make way for redirect?

$1`,pageCouplingError:`Cannot couple pages correctly. Please check that each line on the left panel corresponds to each line on the right panel.

Error on Line $1: from page $2, to page $3`,queryError:"Unexpected error on page info query.",inCooldown:"$1/$2 (in cooldown)",consoleRedirectFail:"Redirect edit failed: from page $1, to page $2.",consoleDeleteFail:"Failed to delete file page $1 for redirecting to $2.",consoleDeleteNoPerm:"Not enough permission to delete file page $1 for redirecting to $2.",consoleDeleteSkipped:"User skipped a file page redirect: from page $1, to page $2."}),c.Message.prototype.escape===void 0&&(c.Message.prototype.escape=c.Message.prototype.escaped);var i={getMessages:function(){return e}};return["setDefaultLang","setTempLang","useLang","usePageLang","useContentLang","usePageViewLang","useUserLang"].forEach(function(t){i[t]=a.noop}),["inLang","inPageLang","inContentLang","inPageViewLang","inUserLang"].forEach(function(t){i[t]=function(){return this}}),i}})(D,mediaWiki)},{css:["#batchredirect-form #form-main-wrapper{display:flex;flex-direction:row;gap:1em;justify-content:space-between;align-items:stretch}#form-main-wrapper div{display:flex;flex-direction:column;justify-content:end;width:50%}#batchredirect-form textarea{width:100%;height:20em;resize:none;padding:8px 12px}#batchredirect-form #text-error-output{background-color:#ffbfbf;color:#000;width:100%;box-sizing:border-box;min-height:120px;padding:8px 12px;overflow:auto}"]},{},{},null]})})(mediaWiki);
